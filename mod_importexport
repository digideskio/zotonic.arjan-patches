diff -r 0c1394664afa include/zotonic.hrl
--- a/include/zotonic.hrl	Sat Sep 25 11:22:59 2010 +0200
+++ b/include/zotonic.hrl	Sun Sep 26 19:27:35 2010 +0200
@@ -110,6 +110,9 @@
 %% For the z_db definitions
 -record(column_def, {name, type, length, is_nullable=true, default}).
 
+%% For the datamodel: default resources to create.
+-record(datamodel, {categories=[], predicates=[], resources=[], media=[], menu=[], edges=[]}).
+
 %% ACL administrator user id
 -define(ACL_ADMIN_USER_ID, 1).
 -define(ACL_ANONYMOUS_USER_ID, -1).
diff -r 0c1394664afa modules/mod_admin/resources/resource_admin_media_preview.erl
--- a/modules/mod_admin/resources/resource_admin_media_preview.erl	Sat Sep 25 11:22:59 2010 +0200
+++ b/modules/mod_admin/resources/resource_admin_media_preview.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -65,7 +65,7 @@
 
 to_image(ReqData, Context) ->
     Opts = [{width, 100}, {height, 100}],
-    Id = z_convert:to_integer(z_context:get("id", Context)),
+    Id = m_rsc:rid(z_context:get("id", Context), Context),
     {ok, Url} = z_media_tag:url(Id, Opts, Context),
     ReqData1 = wrq:set_resp_header("Location", binary_to_list(Url), ReqData),
     {{halt, 303}, ReqData1, Context}.
diff -r 0c1394664afa modules/mod_base/filters/filter_summary.erl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/modules/mod_base/filters/filter_summary.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -0,0 +1,39 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2010 Arjan Scherpenisse
+%% @doc Give a plaintext summary of the resource. Takes either the summary or, if non existent, a part of the body text.
+
+%% Copyright 2010 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(filter_summary).
+-export([summary/2, summary/3]).
+
+
+summary(undefined, _Context) ->
+    undefined;
+summary(RId, Context) ->
+    summary(RId, 200, Context).
+
+summary(undefined, _N, _Context) ->
+    undefined;
+summary(RId, N, Context) ->
+    Id = m_rsc:rid(RId, Context),
+    S = case m_rsc:p(Id, summary, Context) of
+            X when X =/= [] andalso X =/= <<>> andalso X =/= undefined ->
+                X;
+            _Empty ->
+                Body = m_rsc:p(Id, body, Context),
+                z_html:strip(Body)
+    end,
+    z_string:truncate(S, z_convert:to_integer(N)).
diff -r 0c1394664afa modules/mod_importexport/mod_importexport.erl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/modules/mod_importexport/mod_importexport.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -0,0 +1,44 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2010 Arjan Scherpenisse
+%% @date 2010-09-20
+%% @doc Import/export for zotonic.
+
+%% Copyright 2009 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%%
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%%
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(mod_importexport).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-mod_title("Blog import/export").
+-mod_description("Provides import/export functionality for your blog.").
+
+-include_lib("zotonic.hrl").
+
+%% interface functions
+-export([
+	event/2
+]).
+
+
+event({submit, {wxr_upload, []}, _TriggerId, _TargetId}, Context) ->
+	{upload, OriginalFilename, TmpFile} = z_context:get_q_validated("upload_file", Context),
+
+    spawn(fun() ->
+                  ok = importexport_import_wordpress:wxr_import(TmpFile, Context),
+                  Msg = lists:flatten(io_lib:format("The import of ~p has completed.", [OriginalFilename])),
+                  z_session_manager:broadcast(#broadcast{type="notice", message=Msg, title="Wordpress import", stay=false}, Context)
+          end),
+
+    Context1 = z_render:growl("Please hold on while the file is importing. You will get a notification when it is ready.", Context),
+	z_render:wire([{dialog_close, []}], Context1).
diff -r 0c1394664afa modules/mod_importexport/support/importexport_import_wordpress.erl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/modules/mod_importexport/support/importexport_import_wordpress.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -0,0 +1,293 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2010 Arjan Scherpenisse
+%% @date 2010-09-20
+%% @doc Wordpress WXR import.
+
+%% Copyright 2010 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+-module(importexport_import_wordpress).
+
+
+-export([
+         wxr_import/2,
+         wxr_to_datamodel/2,
+         test/0
+        ]).
+
+
+-include_lib("xmerl/include/xmerl.hrl").
+-include("zotonic.hrl").
+
+
+-define(RSS_NS, 'http://purl.org/rss/1.0/modules/content/').
+-define(WFW_NS, 'http://wellformedweb.org/CommentAPI/').
+-define(DC_NS, 'http://purl.org/dc/elements/1.1/').
+-define(WP_NS, "http://wordpress.org/export/1.0/").
+
+
+wxr_import(Filename, Context) ->
+    z_datamodel:manage(?MODULE, wxr_to_datamodel(Filename, Context), Context).
+
+
+wxr_to_datamodel(Filename, Context) ->
+    {RootElem, _} = xmerl_scan:file(Filename),
+    [Channel] = xmerl_xpath:string("/rss/channel", RootElem),
+
+    %% Make sure we support the right version. FIXME - make more flexible.
+    [Version] = xmerl_xpath:string("wp:wxr_version", Channel),
+    <<"1.0">> = get_xmltext(Version),
+
+    [Link] = xmerl_xpath:string("link", Channel),
+    Base = z_convert:to_list(get_xmltext(Link)),
+
+    Data = #datamodel{},
+
+    %% Import the categories as keywords
+    Keywords = xmerl_xpath:string("wp:category", Channel),
+    {Data1, _, _} = lists:foldl(fun import_wxr_category/2, {Data, Base, Context}, Keywords),
+
+    %% Import all tags 
+    Tags = xmerl_xpath:string("//category[@domain=\"tag\"]", Channel),
+    {Data2, _, _} = lists:foldl(fun import_wxr_tag/2, {Data1, Base, Context}, Tags),
+
+    %% Import the posts
+    Items = xmerl_xpath:string("item", Channel),
+    {Data3, _, _} = lists:foldl(fun import_wxr_item/2, {Data2, Base, Context}, Items),
+
+    %% Import the authors
+    Authors = xmerl_xpath:string("//dc:creator", Channel),
+    {Data4, _, _} = lists:foldl(fun import_wxr_creator/2, {Data3, Base, Context}, Authors),
+
+    %% FIXME in resources; for every category that is of type
+    %% 'revision'; only insert the resource with the highest post id
+    %% for that parent.
+
+    Data4.
+
+
+element_content(XPath, Node) ->
+    [X] = xmerl_xpath:string(XPath, Node), get_xmltext(X).
+
+
+import_wxr_item(Item, {Data=#datamodel{resources=R,edges=E}, Base, Context}) ->
+    %%?DEBUG(1),
+    %%Data2 = Data#datamodel{resources=[1|R]},
+    Title = element_content("title", Item),
+    Name = "wordpress_" ++ z_convert:to_list(element_content("wp:post_id", Item)),
+    Body = element_content("content:encoded", Item),
+    Summary = element_content("description", Item),
+    IsPublished = map_wp_status(element_content("wp:status", Item)),
+    PostParent = z_convert:to_integer(element_content("wp:post_parent", Item)),
+
+    Props =
+        [{title, Title},
+         {body, wp_embed_tags(Body)},
+         {summary, Summary},
+         {is_published, IsPublished},
+         {custom_slug, true},
+         {slug, element_content("wp:post_name", Item)},
+         {wp_post_id, element_content("wp:post_id", Item)},
+         {wp_post_parent, PostParent}
+        ],
+
+    Props1 = case xmerl_xpath:string("wp:attachment_url", Item) of
+                 [] -> Props;
+                 [U] -> [{media_url, z_convert:to_list(get_xmltext(U))} | Props]
+             end,
+
+    Props2 = case z_convert:to_datetime(z_convert:to_list(element_content("wp:post_date", Item))) of
+                 {{0,0,0},{0,0,0}} -> Props1;
+                 D ->
+                     [{publication_start, D}|Props1]
+             end,
+
+    Edges = [],
+
+    Edges1 = case xmerl_xpath:string("dc:creator", Item) of
+                 [] -> Edges;
+                 [C] -> [{Name, author, get_xmltext(C)} | Edges]
+             end,
+
+    Edges2 = lists:foldl(fun(Edg, Es) ->
+                                 case xml_attrib(nicename, Edg) of
+                                     undefined -> Es;
+                                     Nm -> [{Name, subject, Nm} | Es]
+                                 end
+                         end, Edges1, xmerl_xpath:string("category[@domain=\"category\"]", Item)),
+    Edges3 = lists:foldl(fun(Edg, Es) ->
+                                 case xml_attrib(nicename, Edg) of
+                                     undefined -> Es;
+                                     Nm -> [{Name, subject, "tag_"++z_convert:to_list(Nm)} | Es]
+                                 end
+                         end, Edges2, xmerl_xpath:string("category[@domain=\"tag\"]", Item)),
+
+    [Cat0] = xmerl_xpath:string("wp:post_type", Item),
+    case map_wp_cat(get_xmltext(Cat0)) of
+        undefined ->
+            %% Skip unknown categories
+            {Data, Base, Context};
+        Cat ->
+            Edges4 = case Cat =:= media andalso PostParent =/= 0 of 
+                         true -> 
+                             %% When its a media, look at post parent and insert parent->depiction->media edge.
+                             P = lists:flatten(io_lib:format("wordpress_~p", [PostParent])),
+                             [ {P, depiction, Name} | Edges3];
+                         _ -> 
+                             Edges3
+                     end,
+            Data2 = Data#datamodel{resources=[{Name,Cat,Props2}|R],edges=Edges4++E},
+            {Data2, Base, Context}
+    end.
+
+
+import_wxr_creator(Creator, {Data=#datamodel{resources=R}, Base, Context}) ->
+    Person = {get_xmltext(Creator),
+              person,
+              [{title, get_xmltext(Creator)}]},
+    Data2 = Data#datamodel{resources=[Person|R]},
+    {Data2, Base, Context}.
+
+
+%% Parse the wp:category tags.
+%% <wp:category><wp:category_nicename>art</wp:category_nicename><wp:category_parent></wp:category_parent><wp:cat_name><![CDATA[Art]]></wp:cat_name><wp:category_description><![CDATA[Everything art related. Stuff I like and stuff I hate, and even stuff I don't care about.]]></wp:category_description></wp:category>
+import_wxr_category(XmlCat, {Data=#datamodel{resources=R}, Base, Context}) ->
+    [Name] = xmerl_xpath:string("wp:category_nicename", XmlCat),
+    [Title] = xmerl_xpath:string("wp:cat_name", XmlCat),
+    Summary = case xmerl_xpath:string("wp:category_description", XmlCat) of
+                  [] -> <<>>;
+                  [El] -> get_xmltext(El)
+              end,
+    Cat = {get_xmltext(Name), keyword, [{title, get_xmltext(Title)}, {summary, Summary}]},
+    Data2 = Data#datamodel{resources=[Cat|R]},
+    {Data2, Base, Context}.
+
+%% Parse the tags with with posts are tagged.
+%% <category domain="tag"><![CDATA[mediamatic workshops toys rfid]]></category>
+import_wxr_tag(XmlCat, {Data=#datamodel{resources=R}, Base, Context}) ->
+    case xml_attrib(nicename, XmlCat) of
+        undefined ->
+            {Data, Base, Context};
+        Nm ->
+            Name = "tag_" ++ z_convert:to_list(Nm),
+            Title = get_xmltext(XmlCat),
+            Cat = {Name, keyword, [{title, Title}]},
+            Data2 = Data#datamodel{resources=[Cat|R]},
+            {Data2, Base, Context}
+    end.
+
+
+map_wp_cat(<<"post">>) -> article;
+map_wp_cat(<<"page">>) -> text;
+map_wp_cat(<<"attachment">>) ->media;
+map_wp_cat(_) -> undefined.
+
+map_wp_status(<<"publish">>) -> true;
+map_wp_status(<<"inherit">>) -> true;
+map_wp_status(_) -> false.
+
+%% @doc Given an element, get its XML text. If "strip" attribute is
+%% set, text is stripped of (x)html constructs if type attribute is
+%% html or xhtml.
+get_xmltext(El) ->
+    get_xmltext(El, true).
+get_xmltext(Element=#xmlElement{content=Content}, Strip) ->
+    Text = collapse_xmltext(Content),
+    Text2 = case Strip of
+                false -> Text;
+                true ->
+                    case xml_attrib(type, Element) of
+                        B when B =:= <<"html">> orelse B =:= <<"xhtml">> ->
+                            %% Strip tags
+                            z_html:strip(Text);
+                        B2 when B2 =:= undefined orelse B2 =:= <<"text">> ->
+                            %% Do not strip.
+                            Text
+                    end
+            end,
+    z_convert:to_binary(Text2).
+
+
+%% @doc Given a list of XML test, implode it into one list.
+%% @spec collapse_xmltext([#xmlText]) -> string()
+collapse_xmltext(Content) ->
+    lists:flatten([X#xmlText.value || X <- Content]).
+
+%% @doc Given an XML element, get the value of an attribute.
+%% @spec xml_attrib(atom(), #xmlElement) -> binary() | undefined
+xml_attrib(Name, #xmlElement{attributes=Attrs}) ->
+    case lists:filter(fun(#xmlAttribute{name=Nm}) -> Nm =:= Name end, Attrs) of
+        [] -> undefined;
+        [#xmlAttribute{value=Value}|_] ->
+            list_to_binary(Value)
+    end.
+
+
+
+wp_embed_tags(B) when is_binary(B) ->
+    list_to_binary(wp_embed_tags(binary_to_list(B)));
+
+wp_embed_tags(BodyText) ->
+    Re = "(<a .*?>)?<img.*?class=\"(.*?wp-image-([0-9]+).*?)\".*?/>(</a>)?",
+    case re:run(BodyText, Re, [{capture, all}]) of
+        nomatch ->
+            BodyText;
+        {match, [{Start, Len}, {-1,0}, {CS, CL}, {IdStart,IdL}]} ->
+            Class = string:substr(BodyText, CS+1,CL),
+            Opts = class_to_embed_opts(Class, false),
+            string:substr(BodyText, 1, Start) 
+                ++ "<!-- z-media wordpress_" ++ string:substr(BodyText, IdStart+1, IdL) ++ " " ++ Opts ++ " -->"
+                ++ wp_embed_tags(string:substr(BodyText, Start+Len+1));
+        {match, [{Start, Len}, {_AS,_AL}, {CS, CL}, {IdStart,IdL}, {_,4}]} ->
+            Class = string:substr(BodyText, CS+1,CL),
+            Opts = class_to_embed_opts(Class, true),
+            string:substr(BodyText, 1, Start) 
+                ++ "<!-- z-media wordpress_" ++ string:substr(BodyText, IdStart+1, IdL) ++ " " ++ Opts ++ " -->"
+                ++ wp_embed_tags(string:substr(BodyText, Start+Len+1))
+%%            ?DEBUG(F)
+%%            {match, [{Start, Len}, {X,Y}, {CS, CL}, {IdStart,IdL}]} ->
+
+    end.
+
+
+class_to_embed_opts(Class, Link) ->
+    Ln = case Link of 
+             true -> "link:true, ";
+             false -> []
+         end,
+    L = lists:flatten([map_class_attr(C) || C <- string:tokens(Class, " ")])++Ln,
+    "{" ++ string:substr(L, 1, length(L)-2) ++ "}".
+
+map_class_attr("alignnone") -> "align:\"block\", ";
+map_class_attr("alignright") -> "align:\"right\", ";
+map_class_attr("alignleft") -> "align:\"left\", ";
+map_class_attr("size-full") -> "size:\"large\", ";
+map_class_attr("size-medium") -> "size:\"middle\", ";
+map_class_attr("size-thumbnail") -> "size:\"small\", ";
+map_class_attr(_) -> [].
+
+
+test() ->
+    "<!-- z-media wordpress_29 {align:\"right\", size:\"large\"} -->" = wp_embed_tags("<img class=\"alignright size-full wp-image-29\" style=\"border: 0pt none; margin-left: 10px;\" title=\"Announcement Retroweek\" src=\"http://idum5.net/blog/wp-content/uploads/poster-klein.jpg\" alt=\"Announcement Retroweek\" width=\"217\" height=\"307\" />"),
+
+    "foobar <!-- z-media wordpress_29 {align:\"left\", size:\"middle\"} -->baz" = wp_embed_tags("foobar <img class=\"alignleft size-medium wp-image-29\" style=\"border: 0pt none; margin-left: 10px;\" title=\"Announcement Retroweek\" src=\"http://idum5.net/blog/wp-content/uploads/poster-klein.jpg\" alt=\"Announcement Retroweek\" width=\"217\" height=\"307\" />baz"),
+
+    "foo<!-- z-media wordpress_29 {align:\"right\", size:\"large\"} -->bar<!-- z-media wordpress_29 {align:\"right\", size:\"large\"} -->baz" = 
+        wp_embed_tags("foo<img class=\"alignright size-full wp-image-29\" style=\"border: 0pt none; margin-left: 10px;\" title=\"Announcement Retroweek\" src=\"http://idum5.net/blog/wp-content/uploads/poster-klein.jpg\" alt=\"Announcement Retroweek\" width=\"217\" height=\"307\" />bar<img class=\"alignright size-full wp-image-29\" style=\"border: 0pt none; margin-left: 10px;\" title=\"Announcement Retroweek\" src=\"http://idum5.net/blog/wp-content/uploads/poster-klein.jpg\" alt=\"Announcement Retroweek\" width=\"217\" height=\"307\" />baz"),
+
+
+    "<!-- z-media wordpress_29 {align:\"right\", size:\"large\", link:true} -->" = wp_embed_tags("<a href=\"http://idum5.net/blog/wp-content/uploads/screenshot4.png\"><img class=\"alignright size-full wp-image-29\" style=\"border: 0pt none; margin-left: 10px;\" title=\"Announcement Retroweek\" src=\"http://idum5.net/blog/wp-content/uploads/poster-klein.jpg\" alt=\"Announcement Retroweek\" width=\"217\" height=\"307\" /></a>"),
+
+    ok.
+
+    
diff -r 0c1394664afa modules/mod_importexport/templates/_admin_status.tpl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/modules/mod_importexport/templates/_admin_status.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -0,0 +1,5 @@
+<h2>{_ Import _}</h2>
+<div class="clearfix">
+    {% button class="" text=_"Wordpress import" action={dialog_open title=_"Import WXR file" template="_dialog_import_wordpress.tpl"} %} 
+    <span class="expl">{_ Import a Wordpress WXR export file into Zotonic. _}</span>
+</div>
diff -r 0c1394664afa modules/mod_importexport/templates/_dialog_import_wordpress.tpl
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/modules/mod_importexport/templates/_dialog_import_wordpress.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -0,0 +1,22 @@
+<p>
+    {_ Upload a wordpress WXR file from your computer. _}
+</p>
+
+
+{% wire id=#form type="submit" delegate="mod_importexport" postback={wxr_upload} %}
+<form id="{{ #form }}" method="POST" action="postback">
+    <div class="new-media-wrapper">
+
+        <div class="form-item clearfix">
+            <label for="upload_file">{_ WXR file _}</label>
+            <input type="file" id="upload_file" name="upload_file" />
+            {% validate id="upload_file" type={presence} %}
+        </div>
+
+        <div class="form-item clearfix">
+            <button type="submit">{_ Start import _}</button>
+            {% button action={dialog_close} text="Cancel" %}
+        </div>
+    </div>
+</form>
+
diff -r 0c1394664afa modules/mod_search/mod_search.erl
--- a/modules/mod_search/mod_search.erl	Sat Sep 25 11:22:59 2010 +0200
+++ b/modules/mod_search/mod_search.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -218,16 +218,16 @@
 
 search({archive_year_month, [{cat,Cat}]}, OffsetLimit, Context) ->
     Q = #search_sql{
-      select="date_part('year', r.publication_start)::varchar as year, date_part('month', r.publication_start)::varchar as month, count(*) as count",
+      select="date_part('year', r.publication_start)::int as year, date_part('month', r.publication_start)::int as month, count(*) as count",
       from="rsc r",
       tables=[{rsc, "r"}],
       assoc=true,
       cats=[{"r", Cat}],
       group_by="date_part('year', r.publication_start), date_part('month', r.publication_start)",
-      order="year desc, month desc"
+      order="year desc, month asc"
      },
     R = z_search:search_result(Q, OffsetLimit, Context),
-    Result = [ [{month_as_date, {{z_convert:to_integer(Y),z_convert:to_integer(M),1},{0,0,0}}}|Rest]
+    Result = [ [{month_as_date, {{Y,M,1},{0,0,0}}}|Rest]
                || Rest = [{year, Y}, {month, M}, {count, _}] <- R#search_result.result],
     #search_result{result=z_utils:group_proplists(year, Result)};
 
diff -r 0c1394664afa priv/sites/default/default.erl
--- a/priv/sites/default/default.erl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/default.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -53,7 +53,7 @@
        {page_about,
         text,
         [{title, <<"About this blog">>},
-         {summary, <<"This is your blog. It would be wise to type some text here on what you will be writing about. Ofcourse, this page is just a demo page and can be deleted just as well.">>}]
+         {summary, <<"This is your blog!! It would be wise to type some text here on what you will be writing about. Ofcourse, this page is just a demo page and can be deleted just as well.">>}]
        },
 
        {page_contact,
diff -r 0c1394664afa priv/sites/default/lib/css/zp-project.css
--- a/priv/sites/default/lib/css/zp-project.css	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/lib/css/zp-project.css	Sun Sep 26 19:27:35 2010 +0200
@@ -237,6 +237,10 @@
 	margin: 0 0 18px 0;
 }	
 
+    .simple-list ul {
+	    margin-left: 9px;
+    }
+
 	.simple-list li a {
 		font-size: 12px;	
 	}
@@ -424,4 +428,26 @@
 			font-size: 12px;
 			color: #666;
 			line-height: 18px;
-		}
\ No newline at end of file
+		}
+
+
+/* Inline list
+---------------------------------------------------------- */
+li a.caption {
+    font-weight: bold;
+}
+
+.inline-list {
+	margin: 0 0 18px 0;
+    clear: both;
+}	
+
+    .inline-list li {
+        float: left;
+        margin-right: 4px;
+    }
+
+
+	.inline-list li a {
+		font-size: 12px;	
+	}
diff -r 0c1394664afa priv/sites/default/templates/_article_meta.tpl
--- a/priv/sites/default/templates/_article_meta.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/_article_meta.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -1,1 +1,3 @@
-<p class="article-meta">Posted on {{ m.rsc[id].publication_start|date:"d F Y"}}</p>
\ No newline at end of file
+<p class="article-meta">Posted on {{ m.rsc[id].publication_start|date:"d F Y"}}
+{% if m.rsc[id].author.id %}by {{ m.rsc[id].author.title }}{% endif %}
+</p>
diff -r 0c1394664afa priv/sites/default/templates/_article_sidebar.tpl
--- a/priv/sites/default/templates/_article_sidebar.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/_article_sidebar.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -5,16 +5,7 @@
 		<ul class="images-list">
 			{% for m in media %}
 				<li>
-					{% ifequal m.rsc[m].medium.mime "text/html-video-embed" %}
-						<section class="video-wrapper">
-							{% media m.rsc[m].medium %}
-						</section>
-					{% else %}
-						<figure class="image-wrapper block-level-image">
-							{% media m width=315 extent %}
-							{% if m.rsc[m].summary %}<p class="image-caption">{{ m.rsc[m].summary }}</p>{% endif %}
-						</figure>	
-					{% endifequal %}
+                    {% include "_body_media.tpl" width=315 align="block" %}
 				</li>
 			{% endfor %}
 		</ul>
diff -r 0c1394664afa priv/sites/default/templates/_article_summary.tpl
--- a/priv/sites/default/templates/_article_summary.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/_article_summary.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -18,7 +18,7 @@
 		{% endifequal %}
 			
 		<p class="important">
-			{{ m.rsc[id].summary }} <a href="{{ m.rsc[id].page_url }}">Read&nbsp;more&nbsp;&raquo;</a>
+			{{ id|summary:300 }} <a href="{{ m.rsc[id].page_url }}">Read&nbsp;more&nbsp;&raquo;</a>
 		</p>
 
 	
@@ -33,8 +33,8 @@
 		<h1><a href="{{m.rsc[id].page_url }}">{{ m.rsc[id].title }}</a></h1>
 		{% include "_article_meta.tpl" id=id %}
 		<p class="summary">
-			{{ m.rsc[id].summary | truncate:100 }} <a href="{{ m.rsc[id].page_url }}">Read&nbsp;more&nbsp;&raquo;</a>
+			{{ m.rsc[id].summary|default:m.rsc[id].body|striptags|truncate:100 }} <a href="{{ m.rsc[id].page_url }}">Read&nbsp;more&nbsp;&raquo;</a>
 		</p>
 	</section>
 
-{% endif %}	
\ No newline at end of file
+{% endif %}	
diff -r 0c1394664afa priv/sites/default/templates/_body_media.tpl
--- a/priv/sites/default/templates/_body_media.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/_body_media.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -5,10 +5,10 @@
 		</section>
 	{% else %}
 		<figure class="image-wrapper block-level-image">
-			{% media m.rsc[id].medium width=size.width height=size.height crop=crop class=align link=link alt=m.rsc[id].title %}
-			{% if m.rsc[id].summary %}<p class="image-caption">{{ m.rsc[id].summary }}</p>{% endif %}
+			{% media m.rsc[id].medium width=size.width|default:width height=size.height|default:height crop=crop class=align link=link alt=m.rsc[id].title %}
+            {% with id|summary as summary %}{% if summary %}<p class="image-caption">{{ summary }}</p>{% endif %}{% endwith %}
 		</figure>	
 	{% endifequal %}
 {% else %}
-	{% media m.rsc[id].medium width=size.width height=size.height crop=crop class=align link=link alt=m.rsc[id].title %}
+	{% media m.rsc[id].medium width=size.width|default:width height=size.height|default:height crop=crop class=align link=link alt=m.rsc[id].title %}
 {% endifequal %}
diff -r 0c1394664afa priv/sites/default/templates/_sidebar.tpl
--- a/priv/sites/default/templates/_sidebar.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/_sidebar.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -23,28 +23,25 @@
 	{% endif %}
 	
 	<h2>Archive</h2>
-	<ul class="simple-list">
+    <ul class="simple-list">
 		{% for year, months in m.search[{archive_year_month cat='article'}] %}
-	    	<li>
-	        	<a href="{% url archives_y year=year %}">{{ year }}</a>
-		        <ul>
-	    	        {% for row in months %}
-	        	    	<li><a href="{% url archives_m year=year month=row.month %}">{{ row.month_as_date|date:"F" }}</a> ({{ row.count }})</li>
-		           	{% endfor %}
-	    	    </ul>
-	    	</li>
+	    	<li><a class="caption" href="{% url archives_y year=year %}">{{ year }}</a>
+                <ul>
+                    {% for row in months %}
+                    <li><a href="{% url archives_m year=year month=row.month %}">{{ row.month_as_date|date:"F" }}</a> ({{ row.count }}){% if not forloop.last %},{% else %}.{% endif %}</li>
+                    {% endfor %}
+                </ul>
+            </li>
 	    {% endfor %}
-	</ul>
+    </ul>
 	
-	{% if show_cloud %}
-		<h2>Keywords</h2>
-		<ul class="simple-list">
-		    {% for id, count in m.search[{keyword_cloud cat='article'}] %}
-		    	<li><a href="{{ m.rsc[id].page_url }}">{{ m.rsc[id].title }}</a> ({{ count }})</li>
-		    {% endfor %}
-		</ul>
-	{% endif %}
-	
+    <h2>Keywords</h2>
+    <ul class="inline-list clearfix">
+	    {% for id, count in m.search[{keyword_cloud cat='article'}] %}
+        <li><a href="{{ m.rsc[id].page_url }}">{{ m.rsc[id].title }}</a> ({{ count }}){% if not forloop.last %},{% else %}.{% endif %}</li>
+	    {% endfor %}
+    </ul>
+
 {% endcache %}
 
 {% if m.rsc[id].is_editable %}
diff -r 0c1394664afa priv/sites/default/templates/archives.tpl
--- a/priv/sites/default/templates/archives.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/archives.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -16,8 +16,8 @@
 		
 		{% endfor %}
 	
-		{% pager result=result dispatch='archives_y' year=q.year %}
+		{% pager result=result dispatch=zotonic_dispatch year=q.year month=q.month %}
 
 	{% endwith %}
 
-{% endblock %}
\ No newline at end of file
+{% endblock %}
diff -r 0c1394664afa priv/sites/default/templates/article.tpl
--- a/priv/sites/default/templates/article.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/article.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -12,12 +12,14 @@
 
     <h1>{{ m.rsc[id].title }}</h1>
 
+    {% if m.rsc[id].summary %}
     <p class="summary">
         {{ m.rsc[id].summary }}
     </p>
+    {% endif %}
 
     {{ m.rsc[id].body|show_media }}
-	
+
 	<section id="comments">{% include "_comments.tpl" id=id %}</section>
 	{% include "_article_prevnext.tpl" id=id %}
 
@@ -25,4 +27,4 @@
 
 {% block sidebar %}
 	{% include "_article_sidebar.tpl" %}
-{% endblock %}
\ No newline at end of file
+{% endblock %}
diff -r 0c1394664afa priv/sites/default/templates/by_keyword.tpl
--- a/priv/sites/default/templates/by_keyword.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/by_keyword.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -8,13 +8,13 @@
 
 {% block content %}
 
-	{% with m.search.paged[{referrers id=q.id}] as result %}
+	{% with m.search.paged[{referrers id=q.id page=q.page pagelen=m.config.site.pagelen.value}] as result %}
 	
 		{% for id, predicate in result %}
 			{% include "_article_summary.tpl" id=id %}
 		{% endfor %}
 		
-		{% pager result=result dispatch='archives_y' year=q.year %}
+		{% pager result=result dispatch='keyword' id=id slug=m.rsc[id].slug %}
 	
 	{% endwith %}
 
diff -r 0c1394664afa priv/sites/default/templates/home.tpl
--- a/priv/sites/default/templates/home.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/home.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -7,13 +7,10 @@
 	{% if m.rsc[id].is_featured %}
 	
 		<h1>{{ m.rsc[id].title }}</h1>
-		<p class="summary">{{ m.rsc[id].summary }}</p>
+		<p class="summary">{{ id|summary }}</p>
 	
 		{% for id in m.rsc[id].media %}
-			<figure class="image-wrapper block-level-image">
-				{% media id width=445 crop class=align alt=m.rsc[id].title %}
-				{% if m.rsc[id].summary %}<p class="image-caption">{{ m.rsc[id].summary }}</p>{% endif %}
-			</figure>
+           {% include "_body_media.tpl" width=445 crop=1 align="block" %}
 		{% endfor %}
 
 	{% endif %}
diff -r 0c1394664afa priv/sites/default/templates/page.tpl
--- a/priv/sites/default/templates/page.tpl	Sat Sep 25 11:22:59 2010 +0200
+++ b/priv/sites/default/templates/page.tpl	Sun Sep 26 19:27:35 2010 +0200
@@ -6,16 +6,16 @@
 
     <h1>{{ m.rsc[id].title }}</h1>
 
+    {% if m.rsc[id].summary %}
     <p class="summary">
         {{ m.rsc[id].summary }}
     </p>
+    {% endif %}
 
     {% if m.rsc[id].medium %}
-    
     	<figure class="image-wrapper block-level-image">
 			{% media m.rsc[id].medium width=445 crop class=align alt=m.rsc[id].title %}
 		</figure>
-    
     {% endif %}
 
     {{ m.rsc[id].body|show_media }}
diff -r 0c1394664afa src/support/z_datamodel.erl
--- a/src/support/z_datamodel.erl	Sat Sep 25 11:22:59 2010 +0200
+++ b/src/support/z_datamodel.erl	Sun Sep 26 19:27:35 2010 +0200
@@ -35,33 +35,26 @@
 -include_lib("zotonic.hrl").
 
 
+manage(Module, Datamodel, Context) when is_list(Datamodel) ->
+    %% Backwards compatibility with old datamodel notation.
+    manage(Module, 
+           #datamodel{categories=proplists:get_value(categories, Datamodel, []),
+                      predicates=proplists:get_value(predicates, Datamodel, []),
+                      resources=proplists:get_value(resources, Datamodel, []),
+                      media=proplists:get_value(media, Datamodel, []),
+                      menu=proplists:get_value(menu, Datamodel, []),
+                      edges=proplists:get_value(edges, Datamodel, [])
+                     }, 
+           Context);
 
-manage(Module, Datamodel, Context) ->
+manage(Module, Datamodel=#datamodel{}, Context) ->
 	AdminContext = z_acl:sudo(Context),
-    case proplists:get_value(categories, Datamodel) of
-        undefined  -> ok;
-        Categories -> [manage_category(Module, Cat, AdminContext) || Cat <- Categories]
-    end,
-    case proplists:get_value(predicates, Datamodel) of
-        undefined -> ok;
-        Preds     -> [manage_predicate(Module, Pred, AdminContext) || Pred <- Preds]
-    end,
-    case proplists:get_value(resources, Datamodel) of
-        undefined -> ok;
-        Rs        -> [manage_resource(Module, R, AdminContext) || R <- Rs]
-    end,
-    case proplists:get_value(media, Datamodel) of
-        undefined -> ok;
-        Ms        -> [manage_medium(Module, Medium, AdminContext) || Medium <- Ms]
-    end,
-    case proplists:get_value(menu, Datamodel) of
-        undefined -> ok;
-        Menu      -> manage_menu(Module, Menu, AdminContext)
-    end,
-    case proplists:get_value(edges, Datamodel) of
-        undefined -> ok;
-        Edges     -> [manage_edge(Module, Edge, AdminContext) || Edge <- Edges]
-    end,
+    [manage_category(Module, Cat, AdminContext) || Cat <- Datamodel#datamodel.categories],
+    [manage_predicate(Module, Pred, AdminContext) || Pred <- Datamodel#datamodel.predicates],
+    [manage_resource(Module, R, AdminContext) || R <- Datamodel#datamodel.resources],
+    [manage_medium(Module, Medium, AdminContext) || Medium <- Datamodel#datamodel.media],
+    manage_menu(Module, Datamodel#datamodel.menu, AdminContext),
+    [manage_edge(Module, Edge, AdminContext) || Edge <- Datamodel#datamodel.edges],
     ok.
 
 
@@ -128,11 +121,12 @@
                 {ok, Id} ->
                     case m_rsc:p(Id, installed_by, Context) of
                         Module ->
+                            NewProps = update_new_props(Module, Id, Props, Context),
+                            m_rsc:update(Id, [{managed_props, z_html:escape_props(Props)} | NewProps], Context),
                             {ok};
                         _ ->
                             %% Resource exists but is not installed by us.
-                            Msg = io_lib:format("Resource '~p' (~p) exists but is not managed by Zotonic.", [Name, Id]),
-                            ?zInfo(Msg, Context),
+                            ?zInfo(io_lib:format("Resource '~p' (~p) exists but is not managed by ~p.", [Name, Id, Module]), Context),
                             {ok}
                     end;
                 {error, {unknown_rsc, _}} ->
@@ -153,7 +147,7 @@
                     {Result, NewNames} = case lists:member(Name, ManagedNames) of
                                              false ->
                                                  Props1 = [{name, Name}, {category_id, CatId},
-                                                           {installed_by, Module}, {managed_props, Props}] ++ Props,
+                                                           {installed_by, Module}, {managed_props, z_html:escape_props(Props)}] ++ Props,
                                                  Props2 = case proplists:get_value(is_published, Props1) of
                                                               undefined -> [{is_published, true} | Props1];
                                                               _ -> Props1
@@ -163,7 +157,20 @@
                                                               _ -> Props2
                                                           end,
                                                  ?zInfo(io_lib:format("Creating new resource '~p'", [Name]), Context),
-                                                 {m_rsc:insert(Props3, Context), [Name | ManagedNames ]};
+                                                 {ok, Id} = m_rsc:insert(Props3, Context),
+                                                 case proplists:get_value(media_url, Props3) of
+                                                     undefined ->
+                                                         nop;
+                                                     Url ->
+                                                         m_media:replace_url(Url, Id, [], Context)
+                                                 end,
+                                                 case proplists:get_value(media_file, Props3) of
+                                                     undefined ->
+                                                         nop;
+                                                     File ->
+                                                         m_media:replace_file(File, Id, Context)
+                                                 end,
+                                                 {{ok, Id}, [Name | ManagedNames ]};
                                              true ->
                                                  ?zInfo(io_lib:format("Resource '~p' was deleted", [Name]), Context),
                                                  {{ok}, ManagedNames}
@@ -177,6 +184,37 @@
             {ok}
     end.
 
+update_new_props(Module, Id, NewProps, Context) ->
+    PreviousProps = m_rsc:p(Id, managed_props, Context),
+    lists:foldl(fun({K, V}, Props) ->
+                        case m_rsc:p(Id, K, Context) of
+                            V ->
+                                %% New value == current value
+                                Props;
+                            DbVal ->
+                                case proplists:get_value(K, PreviousProps) of 
+                                    DbVal ->
+                                        %% New value in NewProps, unchanged in DB
+                                        [{K,V} | Props];
+                                    PrevVal when is_binary(DbVal) ->
+                                        %% Compare with converted to list value
+                                        case z_convert:to_list(DbVal) of
+                                            V ->
+                                                Props;
+                                            _ ->
+                                                %% Changed by someone else
+                                                ?zInfo(io_lib:format("~p: ~p of ~p changed in database (~p != ~p), not updating.", [Module, K, Id, DbVal, PrevVal]), Context),
+                                                Props
+                                        end;
+                                    PrevVal2 ->
+
+                                        %% Changed by someone else
+                                        ?zInfo(io_lib:format("~p: ~p of ~p changed in database (~p != ~p), not updating.", [Module, K, Id, DbVal, PrevVal2]), Context),
+                                        Props
+                                end
+                        end
+                end, [], NewProps).
+
 
 manage_predicate_validfor(_Id, [], _Context) ->
     ok;
@@ -213,6 +251,11 @@
 map_prop({file, Filepath}, _Context) ->
     {ok, Txt} = file:read_file(Filepath),
     Txt;
+map_prop({to_id, Name}, Context) ->
+    case m_rsc:name_to_id(Name, Context) of
+             {ok, Id} -> Id;
+             _ -> undefined
+    end;
 map_prop(Value, _Context) ->
     Value.
 
