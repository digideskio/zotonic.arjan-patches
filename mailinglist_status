# HG changeset patch
# Parent 0bdd53c75a41dd8666affc46456bf5379744fd44
Mailinglist separate page for previewing, sending and checking the mailing statistics.

diff --git a/modules/mod_admin/resources/resource_admin_edit.erl b/modules/mod_admin/resources/resource_admin_edit.erl
--- a/modules/mod_admin/resources/resource_admin_edit.erl
+++ b/modules/mod_admin/resources/resource_admin_edit.erl
@@ -23,7 +23,8 @@
     resource_exists/2,
     is_authorized/2,
     event/2,
-    filter_props/1
+    filter_props/1,
+	ensure_id/1
 ]).
 
 -include_lib("resource_html.hrl").
diff --git a/modules/mod_mailinglist/dispatch/dispatch_mailinglist b/modules/mod_mailinglist/dispatch/dispatch_mailinglist
--- a/modules/mod_mailinglist/dispatch/dispatch_mailinglist
+++ b/modules/mod_mailinglist/dispatch/dispatch_mailinglist
@@ -1,5 +1,9 @@
 [
 	{admin_mailinglist, ["admin", "mailinglists"], resource_admin_mailinglist, []},
+
+	{admin_mailing_preview,    ["admin", "mailing", "preview", id],       resource_admin_mailing_preview, []},
+	{admin_mailing_status,    ["admin", "mailing", id],       resource_admin_mailing_status, []},
+
 	{admin_mailinglist_recipients, ["admin", "mailinglists", "recipients", id ], resource_admin_mailinglist_recipients, []},
 	
 	{mailinglist_confirm, ["mailinglist", "confirm", confirm_key], resource_template, [{template, "mailinglist_confirm.tpl"}]},
@@ -7,6 +11,7 @@
 	
 	{mailinglist_export, ["mailinglist", "export", id], resource_mailinglist_export, []},
 
+
 	%% Normal page to show a resource.
 	{mailinglist,    ["mailinglist", id],       resource_page, [ {template, {cat, "mailinglist.tpl"}} ]},
 	{mailinglist,    ["mailinglist", id, slug], resource_page, [ {template, {cat, "mailinglist.tpl"}} ]}
diff --git a/modules/mod_mailinglist/mod_mailinglist.erl b/modules/mod_mailinglist/mod_mailinglist.erl
--- a/modules/mod_mailinglist/mod_mailinglist.erl
+++ b/modules/mod_mailinglist/mod_mailinglist.erl
@@ -302,20 +302,8 @@
     Recipients = m_mailinglist:get_enabled_recipients(ListId, Context),
     SubscribersOf = m_edge:subjects(ListId, subscriberof, Context),
     {Direct,Queued} = split_list(20, Recipients ++ SubscribersOf),
-    FromEmail = case m_rsc:p(ListId, mailinglist_reply_to, Context) of
-                    Empty when Empty =:= undefined; Empty =:= <<>> ->
-                        z_convert:to_list(m_config:get_value(mod_emailer, email_from, Context));
-                    RT ->
-                        z_convert:to_list(RT)
-                end,
-    FromName = case m_rsc:p(ListId, mailinglist_sender_name, Context) of
-                  undefined -> [];
-                  <<>> -> []; 
-                  SenderName -> z_convert:to_list(SenderName)
-               end,
-    From = z_email:combine_name_email(FromName, FromEmail),
     Options = [
-        {id,PageId}, {list_id, ListId}, {email_from, From}
+        {id,PageId}, {list_id, ListId}, {email_from, m_mailinglist:get_email_from(ListId, Context)}
     ],
     
     [ send(true, Email, Options, Context) || Email <- Direct ],
diff --git a/modules/mod_mailinglist/models/m_mailinglist.erl b/modules/mod_mailinglist/models/m_mailinglist.erl
--- a/modules/mod_mailinglist/models/m_mailinglist.erl
+++ b/modules/mod_mailinglist/models/m_mailinglist.erl
@@ -51,6 +51,8 @@
 	get_scheduled/2,
 	check_scheduled/1,
 
+	get_email_from/2,
+
 	init_tables/1
 ]).
 
@@ -63,6 +65,10 @@
    M#m{value=stats};
 m_find_value(Id, #m{value=stats}, Context) ->
    get_stats(Id, Context);
+m_find_value(rsc_stats, #m{value=undefined} = M, _Context) ->
+   M#m{value=rsc_stats};
+m_find_value(Id, #m{value=rsc_stats}, Context) ->
+   get_rsc_stats(Id, Context);
 m_find_value(recipient, #m{value=undefined} = M, _Context) ->
    M#m{value=recipient};
 m_find_value(Id, #m{value=recipient}, Context) ->
@@ -110,6 +116,23 @@
 	{Count, Scheduled}.
 
 
+%% @doc Get the stats for all mailing lists which have been sent to a rsc (content_id)
+%% @spec get_rsc_stats(int(), Context) -> [ {mailinglist_id::int(), statlist} ]
+get_rsc_stats(Id, Context) ->
+    Stats = [ {ListId, [{created, Created}, {total, Total}]} || 
+                {ListId, Created, Total} <- z_db:q("select other_id, min(created) as sent_on, count(distinct(envelop_to)) from log_email where content_id = $1 group by other_id", [Id], Context)],
+
+    %% merge in all mailer statuses
+    lists:foldl(fun({ListId, Status, Count}, St) ->
+                        z_utils:prop_replace(ListId,
+                                             [{z_convert:to_atom(Status), Count}|proplists:get_value(ListId, St, [])],
+                                             St)
+                end,
+                Stats,
+                z_db:q("select other_id, mailer_status, count(distinct(envelop_to)) from log_email where content_id = $1 group by other_id, mailer_status", [Id], Context)).
+
+
+
 %% @doc Fetch all enabled recipients from a list.
 get_enabled_recipients(ListId, Context) ->
 	Emails = z_db:q("select email from mailinglist_recipient where mailinglist_id = $1 and is_enabled = true", [ListId], Context),
@@ -365,6 +388,22 @@
 		limit 1", Context).
 
 
+%% @doc Get the "from" address used for this mailing list. Looks first in the mailinglist rsc for a ' mailinglist_reply_to' field; falls back to mod_emailer.email_from config variable.
+get_email_from(ListId, Context) ->
+    FromEmail = case m_rsc:p(ListId, mailinglist_reply_to, Context) of
+                    Empty when Empty =:= undefined; Empty =:= <<>> ->
+                        z_convert:to_list(m_config:get_value(mod_emailer, email_from, Context));
+                    RT ->
+                        z_convert:to_list(RT)
+                end,
+    FromName = case m_rsc:p(ListId, mailinglist_sender_name, Context) of
+                  undefined -> [];
+                  <<>> -> []; 
+                  SenderName -> z_convert:to_list(SenderName)
+               end,
+    z_email:combine_name_email(FromName, FromEmail).
+
+
 % Install the SQL tables to track recipients and scheduled mailings.
 init_tables(Context) ->
 	case z_db:table_exists(mailinglist_recipient, Context) of
diff --git a/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl b/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl
@@ -0,0 +1,48 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2011 Arjan Scherpenisse
+%% @doc Mailing status/control page
+
+%% Copyright 2011 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(resource_admin_mailing_preview).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-export([
+    resource_exists/2,
+    is_authorized/2
+]).
+
+-include_lib("resource_html.hrl").
+
+%% @todo Change this into "visible" and add a view instead of edit template.
+is_authorized(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    z_acl:wm_is_authorized([{use, mod_mailinglist}, {view, Id}], Context2).
+
+
+resource_exists(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    case Id of
+        undefined -> ?WM_REPLY(false, Context2);
+        _N -> ?WM_REPLY(m_rsc:exists(Id, Context2), Context2)
+    end.
+        
+
+html(Context) ->
+    PageId = z_context:get(id, Context),
+    ListId = m_rsc:rid(mailinglist_test, Context),
+    Vars = [{id,PageId}, {list_id, ListId}, {email_from, m_mailinglist:get_email_from(ListId, Context)}],
+    Html = z_template:render({cat, "mailing_page.tpl"}, Vars, Context),
+	z_context:output(Html, Context).
diff --git a/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl b/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl
@@ -0,0 +1,48 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2011 Arjan Scherpenisse
+%% @doc Mailing status/control page
+
+%% Copyright 2011 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(resource_admin_mailing_status).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-export([
+    resource_exists/2,
+    is_authorized/2
+]).
+
+-include_lib("resource_html.hrl").
+
+%% @todo Change this into "visible" and add a view instead of edit template.
+is_authorized(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    z_acl:wm_is_authorized([{use, mod_mailinglist}, {view, Id}], Context2).
+
+
+resource_exists(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    case Id of
+        undefined -> ?WM_REPLY(false, Context2);
+        _N -> ?WM_REPLY(m_rsc:exists(Id, Context2), Context2)
+    end.
+        
+
+html(Context) ->
+    Vars = [
+        {id, z_context:get(id, Context)}
+    ],
+    Html = z_template:render({cat, "admin_mailing_status.tpl"}, Vars, Context),
+	z_context:output(Html, Context).
diff --git a/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl b/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
--- a/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
+++ b/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
@@ -1,25 +1,12 @@
 {% extends "admin_edit_widget_std.tpl" %}
 
 {% block widget_title %}{_ Send to mailing list _}{% endblock %}
-{% block widget_show_minimized %}{{ m.mailinglist.scheduled[id]|yesno:"false,true" }}{% endblock %}
+{% block widget_show_minimized %}false{% endblock %}
 
 {% block widget_content %}
-{% with m.mailinglist.scheduled[id] as scheduled %}
-<div class="notification notice">
-	{_ Send this page to a mailing list. _}
-	<a href="javascript:void(0)" class="do_dialog"  data-dialog="title: '{_ Help about mailing lists. _}', text: '{_ You can send this page as an e-mail to everyone in a mailing list. If the page has a future publication start date, is not yet published or is not visible for the world then the mail will be send after publication of the page. _}', width: '450px'">{_ Need more help? _}</a>
+
+
+<div class="clearfix">
+    <p><a href="{% url admin_mailing_status id=id %}">{_ Mailinglist status _}</a></p>
 </div>
-
-{% button text=_"Send mailing" title=_"Select a mailing list to send this page to." class="do_tooltip" action={dialog_mailing_page id=id} %}
-
-{% button text=_"Send test mailing" class="do_tooltip" disabled=not m.rsc.mailinglist_test.is_visible title=_"Send this page to the test mailing list." action={mailing_page_test id=id} %}
-
-{% button text=_"Email page" title=_"Send this page to an e-mail address." class="do_tooltip" action={dialog_email_page id=id} %}
-
-<div class="clear"></div>
-
-<div id="mailinglist-scheduled">
-	{% include "_mailinglist_scheduled.tpl" id=id scheduled=scheduled %}
-</div>
-{% endwith %}
 {% endblock %}
diff --git a/modules/mod_mailinglist/templates/admin_mailing_status.tpl b/modules/mod_mailinglist/templates/admin_mailing_status.tpl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/templates/admin_mailing_status.tpl
@@ -0,0 +1,26 @@
+{% extends "admin_base.tpl" %}
+
+{% block title %}{_ Mailing status _} &mdash; {{ m.rsc[id].title }}{% endblock %}
+
+{% block content %}
+	<div id="content" class="zp-85">
+		<div class="block clearfix">
+
+            <p class="admin-chapeau">{_ mailinglist status page _}:</p>
+            <h2>{{ m.rsc[id].title }}</h2>
+
+            <div class="clearfix">
+                <a href="{% url admin_edit_rsc id=id %}" class="button">{_ edit _}</a>
+                <a href="{% url admin_mailing_preview id=id %}" class="button" onclick="window.open(this.getAttribute('href'), 'mailingpreview', 'width=800,height=800');return false;">{_ preview mailing _}</a>
+                {% button text=_"Send test mailing" class="do_tooltip" title=_"Send this page to the test mailing list." action={mailing_page_test id=id} %}
+            </div>
+
+            <hr />
+
+            <div class="zp-100">
+                {% include "_admin_mailing_status_overview.tpl" %}
+            </div>
+
+		</div>
+	</div>
+{% endblock %}
diff --git a/src/install/z_install_data.erl b/src/install/z_install_data.erl
--- a/src/install/z_install_data.erl
+++ b/src/install/z_install_data.erl
@@ -57,15 +57,13 @@
     ?DEBUG("Inserting modules"),
     Modules = [
         "mod_base",
-        "mod_emailer",
         "mod_menu",
         "mod_oauth",
         "mod_search",
         "mod_video_embed",
         "mod_atom_feed",
-		"mod_broadcast",
         "mod_translation",
-        "mod_log",
+        "mod_logging",
 
         "mod_seo",
         "mod_seo_google",
@@ -75,13 +73,10 @@
 		"mod_acl_adminonly",
 
         "mod_admin",
-        "mod_admin_address",
         "mod_admin_category",
         "mod_admin_config",
-        "mod_admin_event",
         "mod_admin_identity",
         "mod_admin_modules",
-        "mod_admin_person",
         "mod_admin_predicate",
 
         %% Enable comments
