# HG changeset patch
# Parent 122381d194f5d88827ae53ea741887cadaaac5ef
Mailinglist separate page for previewing, sending and checking the
mailing statistics.  Also allows scheduled sending of mailings when
page becomes visible.

diff --git a/modules/mod_admin/resources/resource_admin_edit.erl b/modules/mod_admin/resources/resource_admin_edit.erl
--- a/modules/mod_admin/resources/resource_admin_edit.erl
+++ b/modules/mod_admin/resources/resource_admin_edit.erl
@@ -23,7 +23,8 @@
     resource_exists/2,
     is_authorized/2,
     event/2,
-    filter_props/1
+    filter_props/1,
+	ensure_id/1
 ]).
 
 -include_lib("resource_html.hrl").
diff --git a/modules/mod_mailinglist/actions/action_mailinglist_dialog_mailing_page.erl b/modules/mod_mailinglist/actions/action_mailinglist_dialog_mailing_page.erl
--- a/modules/mod_mailinglist/actions/action_mailinglist_dialog_mailing_page.erl
+++ b/modules/mod_mailinglist/actions/action_mailinglist_dialog_mailing_page.erl
@@ -30,22 +30,24 @@
 
 render_action(TriggerId, TargetId, Args, Context) ->
     Id = z_convert:to_integer(proplists:get_value(id, Args)),
+    ListId = z_convert:to_integer(proplists:get_value(list_id, Args)),
     OnSuccess = proplists:get_all_values(on_success, Args),
-    Postback = {dialog_mailing_page, Id, OnSuccess},
+    Postback = {dialog_mailing_page, Id, ListId, OnSuccess},
 	{PostbackMsgJS, _PickledPostback} = z_render:make_postback(Postback, click, TriggerId, TargetId, ?MODULE, Context),
 	{PostbackMsgJS, Context}.
 
-event({postback, {dialog_mailing_page, Id, OnSuccess}, _TriggerId, _TargetId}, Context) ->
+event({postback, {dialog_mailing_page, Id, ListId, OnSuccess}, _TriggerId, _TargetId}, Context) ->
 	Vars = [
-		{id, Id},
-		{on_success, OnSuccess}
+            {id, Id},
+            {list_id, ListId},
+            {on_success, OnSuccess}
 	],
-	z_render:dialog("Give e-mail address of recipient.", "_dialog_mailing_page.tpl", Vars, Context);
+	z_render:dialog("Confirm sending to mailinglist.", "_dialog_mailing_page.tpl", Vars, Context);
 
 event({submit, {mailing_page, Args}, _TriggerId, _TargetId}, Context) ->
 	PageId = proplists:get_value(id, Args),
 	OnSuccess = proplists:get_all_values(on_success, Args),
-	ListId = z_convert:to_integer(z_context:get_q("mailinglist_id", Context)),
+	ListId = z_convert:to_integer(z_context:get_q("list_id", Context)),
 	Name = m_rsc:p(ListId, name, Context),
 	Context1 = case Name == <<"mailinglist_test">> orelse z_acl:rsc_visible(PageId, z_acl:anondo(Context)) of
 		true -> 
@@ -53,9 +55,7 @@
 			z_render:growl("The e-mails are being send...", Context);
 		false -> 
 			m_mailinglist:insert_scheduled(ListId, PageId, Context),
+            mod_signal:emit({update_mailinglist_scheduled, [{id, PageId}]}, Context),
 			z_render:growl("The mailing will be send when the page becomes visible.", Context)
 	end,
-	Context2 = mod_mailinglist:update_scheduled_list(PageId, Context1),
-	z_render:wire(OnSuccess, Context2).
-
-
+	z_render:wire(OnSuccess, Context1).
diff --git a/modules/mod_mailinglist/dispatch/dispatch_mailinglist b/modules/mod_mailinglist/dispatch/dispatch_mailinglist
--- a/modules/mod_mailinglist/dispatch/dispatch_mailinglist
+++ b/modules/mod_mailinglist/dispatch/dispatch_mailinglist
@@ -1,5 +1,9 @@
 [
 	{admin_mailinglist, ["admin", "mailinglists"], resource_admin_mailinglist, []},
+
+	{admin_mailing_preview,    ["admin", "mailing", "preview", id],       resource_admin_mailing_preview, []},
+	{admin_mailing_status,    ["admin", "mailing", id],       resource_admin_mailing_status, []},
+
 	{admin_mailinglist_recipients, ["admin", "mailinglists", "recipients", id ], resource_admin_mailinglist_recipients, []},
 	
 	{mailinglist_confirm, ["mailinglist", "confirm", confirm_key], resource_template, [{template, "mailinglist_confirm.tpl"}]},
@@ -7,6 +11,7 @@
 	
 	{mailinglist_export, ["mailinglist", "export", id], resource_mailinglist_export, []},
 
+
 	%% Normal page to show a resource.
 	{mailinglist,    ["mailinglist", id],       resource_page, [ {template, {cat, "mailinglist.tpl"}} ]},
 	{mailinglist,    ["mailinglist", id, slug], resource_page, [ {template, {cat, "mailinglist.tpl"}} ]}
diff --git a/modules/mod_mailinglist/mod_mailinglist.erl b/modules/mod_mailinglist/mod_mailinglist.erl
--- a/modules/mod_mailinglist/mod_mailinglist.erl
+++ b/modules/mod_mailinglist/mod_mailinglist.erl
@@ -34,7 +34,6 @@
 	observe_search_query/2,
 	observe_mailinglist_message/2,
 	event/2,
-	update_scheduled_list/2,
 	datamodel/1,
 	page_attachments/2
 ]).
@@ -106,7 +105,7 @@
 
 %% @doc Request confirmation of canceling this mailing.
 event({postback, {dialog_mailing_cancel_confirm, Args}, _TriggerId, _TargetId}, Context) ->
-	MailingId = proplists:get_value(mailinglist_id, Args),
+	MailingId = proplists:get_value(list_id, Args),
 	case z_acl:rsc_editable(MailingId, Context) of
 		true ->
 			z_render:dialog("Confirm mailing cancelation.", "_dialog_mailing_cancel_confirm.tpl", Args, Context);
@@ -114,13 +113,13 @@
 			z_render:growl_error("You are not allowed to cancel this mailing.", Context)
 	end;
 event({postback, {mailing_cancel, Args}, _TriggerId, _TargetId}, Context) ->
-	MailingId = proplists:get_value(mailinglist_id, Args),
+	MailingId = proplists:get_value(list_id, Args),
 	PageId = proplists:get_value(page_id, Args),
 	case z_acl:rsc_editable(MailingId, Context) of
 		true ->
 			m_mailinglist:delete_scheduled(MailingId, PageId, Context),
-			Context1 = update_scheduled_list(PageId, Context),
-			z_render:growl("The mailing has been canceled.", Context1);
+            mod_signal:emit({update_mailinglist_scheduled, [{id, PageId}]}, Context),
+			z_render:growl("The mailing has been canceled.", Context);
 		false ->
 			z_render:growl_error("You are not allowed to cancel this mailing.", Context)
 	end;
@@ -135,18 +134,8 @@
             z_render:growl(Msg, "error", true, Context)
     end.
 
-%% @doc Update the list with the mailings scheduled for this page.
-update_scheduled_list(Id, Context) ->
-	Vars = [
-		{id, Id},
-		{scheduled, m_mailinglist:get_scheduled(Id, Context)}
-	],
-	Html = z_template:render("_mailinglist_scheduled.tpl", Vars, Context),
-	z_render:update("mailinglist-scheduled", Html, Context).
 
 
-	
-
 %%====================================================================
 %% API
 %%====================================================================
@@ -302,20 +291,8 @@
     Recipients = m_mailinglist:get_enabled_recipients(ListId, Context),
     SubscribersOf = m_edge:subjects(ListId, subscriberof, Context),
     {Direct,Queued} = split_list(20, Recipients ++ SubscribersOf),
-    FromEmail = case m_rsc:p(ListId, mailinglist_reply_to, Context) of
-                    Empty when Empty =:= undefined; Empty =:= <<>> ->
-                        z_convert:to_list(m_config:get_value(mod_emailer, email_from, Context));
-                    RT ->
-                        z_convert:to_list(RT)
-                end,
-    FromName = case m_rsc:p(ListId, mailinglist_sender_name, Context) of
-                  undefined -> [];
-                  <<>> -> []; 
-                  SenderName -> z_convert:to_list(SenderName)
-               end,
-    From = z_email:combine_name_email(FromName, FromEmail),
     Options = [
-        {id,PageId}, {list_id, ListId}, {email_from, From}
+        {id,PageId}, {list_id, ListId}, {email_from, m_mailinglist:get_email_from(ListId, Context)}
     ],
     
     [ send(true, Email, Options, Context) || Email <- Direct ],
@@ -331,13 +308,19 @@
         case z_convert:to_list(z_string:trim(Email)) of
             [] -> skip;
             Email1 ->
-                Options1 = [{email,Email1}|Options],
-
                 Id = proplists:get_value(id, Options),
-                Attachments = mod_mailinglist:page_attachments(Id, Context),
-
-                z_email_server:send(#email{queue=not(IsDirect), to=Email1,
-	                        html_tpl={cat, "mailing_page.tpl"}, vars=Options1, attachments=Attachments}, Context)
+                ListId = proplists:get_value(list_id, Options),
+                %% check if not already sent
+                case m_mailinglist:already_sent(Email1, ListId, Id, Context) of
+                    true ->
+                        ?DEBUG("Already sent..."),
+                        %% already sent...
+                        ok;
+                    false ->
+                        Attachments = mod_mailinglist:page_attachments(Id, Context),
+                        z_email_server:send(#email{queue=not(IsDirect), to=Email1,
+                                                   html_tpl={cat, "mailing_page.tpl"}, vars=[{email,Email1}|Options], attachments=Attachments}, Context)
+                end
         end.
 
 
diff --git a/modules/mod_mailinglist/models/m_mailinglist.erl b/modules/mod_mailinglist/models/m_mailinglist.erl
--- a/modules/mod_mailinglist/models/m_mailinglist.erl
+++ b/modules/mod_mailinglist/models/m_mailinglist.erl
@@ -51,6 +51,9 @@
 	get_scheduled/2,
 	check_scheduled/1,
 
+	get_email_from/2,
+    already_sent/4,
+
 	init_tables/1
 ]).
 
@@ -63,6 +66,10 @@
    M#m{value=stats};
 m_find_value(Id, #m{value=stats}, Context) ->
    get_stats(Id, Context);
+m_find_value(rsc_stats, #m{value=undefined} = M, _Context) ->
+   M#m{value=rsc_stats};
+m_find_value(Id, #m{value=rsc_stats}, Context) ->
+   get_rsc_stats(Id, Context);
 m_find_value(recipient, #m{value=undefined} = M, _Context) ->
    M#m{value=recipient};
 m_find_value(Id, #m{value=recipient}, Context) ->
@@ -107,7 +114,26 @@
 							join rsc on id = page_id
 					where mailinglist_id = $1
 					order by publication_start", [Id], Context),
-	{Count, Scheduled}.
+	{Count + length(m_edge:subjects(Id, subscriber_of, Context)), Scheduled}.
+
+
+%% @doc Get the stats for all mailing lists which have been sent to a rsc (content_id)
+%% @spec get_rsc_stats(int(), Context) -> [ {mailinglist_id::int(), statlist} ]
+get_rsc_stats(Id, Context) ->
+    F = fun() ->
+                Stats = [ {ListId, [{created, Created}, {total, Total}]} || 
+                            {ListId, Created, Total} <- z_db:q("select other_id, min(created) as sent_on, count(distinct(envelop_to)) from log_email where content_id = $1 group by other_id", [Id], Context)],
+                %% merge in all mailer statuses
+                lists:foldl(fun({ListId, Status, Count}, St) ->
+                                    z_utils:prop_replace(ListId,
+                                                         [{z_convert:to_atom(Status), Count}|proplists:get_value(ListId, St, [])],
+                                                         St)
+                            end,
+                            Stats,
+                            z_db:q("select other_id, mailer_status, count(envelop_to) from log_email where content_id = $1 group by other_id, mailer_status", [Id], Context))
+        end,
+    z_depcache:memo(F, {mailinglist_stats, Id}, 5, [Id], Context). %% Cache a little while to prevent database DOS while mail is sending
+
 
 
 %% @doc Fetch all enabled recipients from a list.
@@ -347,9 +373,9 @@
 
 %% @doc Get the list of scheduled mailings for a page.
 get_scheduled(Id, Context) ->
-	z_db:q("select mailinglist_id
-			from mailinglist_scheduled
-			where page_id = $1", [Id], Context).
+	[ListId || {ListId} <- z_db:q("select mailinglist_id
+                			from mailinglist_scheduled
+                			where page_id = $1", [Id], Context)].
 
 
 %% @doc Fetch the next scheduled mailing that is publicly visible, published and in the publication date range.
@@ -365,6 +391,32 @@
 		limit 1", Context).
 
 
+already_sent(Email, ListId, Id, Context) ->
+    case m_rsc:p(ListId, name, Context) of
+        <<"mailinglist_test">> ->
+            false; %% test mailinglist allows duplicates
+        _X ->
+            ?DEBUG(_X),
+            z_convert:to_bool(z_db:q1("select true from log_email where other_id = $1 and content_id = $2 and envelop_to = $3 and mailer_status = 'sent'", [ListId, Id, Email], Context))
+    end.
+
+
+%% @doc Get the "from" address used for this mailing list. Looks first in the mailinglist rsc for a ' mailinglist_reply_to' field; falls back to mod_emailer.email_from config variable.
+get_email_from(ListId, Context) ->
+    FromEmail = case m_rsc:p(ListId, mailinglist_reply_to, Context) of
+                    Empty when Empty =:= undefined; Empty =:= <<>> ->
+                        z_convert:to_list(m_config:get_value(mod_emailer, email_from, Context));
+                    RT ->
+                        z_convert:to_list(RT)
+                end,
+    FromName = case m_rsc:p(ListId, mailinglist_sender_name, Context) of
+                  undefined -> [];
+                  <<>> -> []; 
+                  SenderName -> z_convert:to_list(SenderName)
+               end,
+    z_email:combine_name_email(FromName, FromEmail).
+
+
 % Install the SQL tables to track recipients and scheduled mailings.
 init_tables(Context) ->
 	case z_db:table_exists(mailinglist_recipient, Context) of
diff --git a/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl b/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/resources/resource_admin_mailing_preview.erl
@@ -0,0 +1,48 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2011 Arjan Scherpenisse
+%% @doc Mailing status/control page
+
+%% Copyright 2011 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(resource_admin_mailing_preview).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-export([
+    resource_exists/2,
+    is_authorized/2
+]).
+
+-include_lib("resource_html.hrl").
+
+%% @todo Change this into "visible" and add a view instead of edit template.
+is_authorized(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    z_acl:wm_is_authorized([{use, mod_mailinglist}, {view, Id}], Context2).
+
+
+resource_exists(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    case Id of
+        undefined -> ?WM_REPLY(false, Context2);
+        _N -> ?WM_REPLY(m_rsc:exists(Id, Context2), Context2)
+    end.
+        
+
+html(Context) ->
+    PageId = z_context:get(id, Context),
+    ListId = m_rsc:rid(mailinglist_test, Context),
+    Vars = [{id,PageId}, {list_id, ListId}, {email_from, m_mailinglist:get_email_from(ListId, Context)}],
+    Html = z_template:render({cat, "mailing_page.tpl"}, Vars, Context),
+	z_context:output(Html, Context).
diff --git a/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl b/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/resources/resource_admin_mailing_status.erl
@@ -0,0 +1,48 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2011 Arjan Scherpenisse
+%% @doc Mailing status/control page
+
+%% Copyright 2011 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(resource_admin_mailing_status).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-export([
+    resource_exists/2,
+    is_authorized/2
+]).
+
+-include_lib("resource_html.hrl").
+
+%% @todo Change this into "visible" and add a view instead of edit template.
+is_authorized(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    z_acl:wm_is_authorized([{use, mod_mailinglist}, {view, Id}], Context2).
+
+
+resource_exists(ReqData, Context) ->
+    {Context2, Id} = resource_admin_edit:ensure_id(?WM_REQ(ReqData, Context)),
+    case Id of
+        undefined -> ?WM_REPLY(false, Context2);
+        _N -> ?WM_REPLY(m_rsc:exists(Id, Context2), Context2)
+    end.
+        
+
+html(Context) ->
+    Vars = [
+        {id, z_context:get(id, Context)}
+    ],
+    Html = z_template:render({cat, "admin_mailing_status.tpl"}, Vars, Context),
+	z_context:output(Html, Context).
diff --git a/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl b/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
--- a/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
+++ b/modules/mod_mailinglist/templates/_admin_edit_sidebar.tpl
@@ -1,25 +1,12 @@
 {% extends "admin_edit_widget_std.tpl" %}
 
 {% block widget_title %}{_ Send to mailing list _}{% endblock %}
-{% block widget_show_minimized %}{{ m.mailinglist.scheduled[id]|yesno:"false,true" }}{% endblock %}
+{% block widget_show_minimized %}false{% endblock %}
 
 {% block widget_content %}
-{% with m.mailinglist.scheduled[id] as scheduled %}
-<div class="notification notice">
-	{_ Send this page to a mailing list. _}
-	<a href="javascript:void(0)" class="do_dialog"  data-dialog="title: '{_ Help about mailing lists. _}', text: '{_ You can send this page as an e-mail to everyone in a mailing list. If the page has a future publication start date, is not yet published or is not visible for the world then the mail will be send after publication of the page. _}', width: '450px'">{_ Need more help? _}</a>
+
+
+<div class="clearfix">
+    <p><a href="{% url admin_mailing_status id=id %}">{_ Mailinglist status _}</a></p>
 </div>
-
-{% button text=_"Send mailing" title=_"Select a mailing list to send this page to." class="do_tooltip" action={dialog_mailing_page id=id} %}
-
-{% button text=_"Send test mailing" class="do_tooltip" disabled=not m.rsc.mailinglist_test.is_visible title=_"Send this page to the test mailing list." action={mailing_page_test id=id} %}
-
-{% button text=_"Email page" title=_"Send this page to an e-mail address." class="do_tooltip" action={dialog_email_page id=id} %}
-
-<div class="clear"></div>
-
-<div id="mailinglist-scheduled">
-	{% include "_mailinglist_scheduled.tpl" id=id scheduled=scheduled %}
-</div>
-{% endwith %}
 {% endblock %}
diff --git a/modules/mod_mailinglist/templates/_admin_mailing_status_overview.tpl b/modules/mod_mailinglist/templates/_admin_mailing_status_overview.tpl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/templates/_admin_mailing_status_overview.tpl
@@ -0,0 +1,73 @@
+
+{% with m.mailinglist.rsc_stats[id] as rsc_stats %}
+{% with m.mailinglist.scheduled[id] as scheduled %}
+
+{% if rsc_stats %}
+<p>{{ m.rsc[id].title }} {_ has been sent to the following lists: _}</p>
+{% else %}
+<p>{{ m.rsc[id].title }} {_ has never been sent yet. _}</p>
+{% endif %}
+<h3 class="above-list">{_ Mailing lists _}</h3>
+		<ul class="short-list">
+			<li class="headers clearfix">
+				<span class="zp-45">{_ Title _}</span>
+				<span class="zp-10">{_ Recipients _}</span>
+				<span class="zp-10">{_ Sent on _}</span>
+				<span class="zp-25">{_ Statistics _}</span>
+				<span class="zp-10">{_ Actions _}</span>
+			</li>
+		{% for title, mid in m.search[{all_bytitle cat="mailinglist"}] %}
+            {% with m.mailinglist.stats[mid] as stats %}
+			<li id="mailinglist-{{ mid }}" class="clearfix">
+
+					<span class="zp-45">
+                        <a href="{% url admin_mailinglist_recipients id=mid %}">{{ title|default:"untitled" }}</a>
+                    </span>
+
+                    <span class="zp-10">{{ stats[1]|format_number }}</span>
+
+                    {% if rsc_stats[mid].created %}
+                    <span class="zp-10">
+                        <a href="{% url admin_log_email content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{{ rsc_stats[mid].created|date:"Y-m-d H:i" }}</a>
+                        {% if mid|member:scheduled %}{_ scheduled _}{% endif %}
+                    </span>
+					<span class="zp-25">
+                        {% if stats[1] > rsc_stats[mid].total %}
+                        <a href="{% url admin_log_email status='sent' content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{{ rsc_stats[mid].total|default:0 }} {_ processed _}</a>
+                        {% else %}
+                        <a href="{% url admin_log_email status='sent' content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{_ All processed _}</a>
+                        {% endif %}
+                        (<a href="{% url admin_log_email status='sent' content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{{ rsc_stats[mid].sent|default:0 }} {_ OK _}</a>,
+                         <a href="{% url admin_log_email status='bounce' content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{{ rsc_stats[mid].bounce|default:0 }} {_ bounced _}</a>,
+                         <a href="{% url admin_log_email status='error' content=id other=mid severity=4 %}" title="{_ Click to view log entries _}">{{ rsc_stats[mid].error|default:0 }} {_ error _}</a>)
+                    </span>
+
+                {% else %}
+                    <span class="zp-10">
+                        {% if mid|member:scheduled %}{_ scheduled _}{% endif %}
+                    </span>
+					<span class="zp-25">
+                        -
+                    </span>
+                {% endif %}
+
+					<span class="button-area">
+                        {% if mid|member:scheduled %}
+                                {% button text=_"cancel" postback={dialog_mailing_cancel_confirm list_id=mid page_id=id} delegate="mod_mailinglist"  %}
+                        {% else %}
+                                {% if stats[1] > rsc_stats[mid].total|default:0 %}
+                                {% button text=_"send mailing" action={dialog_mailing_page id=id list_id=mid} title=_"send to "|append:m.rsc[mid].title %}
+                                {% endif %}
+                        {% endif %}
+					</span>
+			</li>
+            {% endwith %}
+		{% empty %}
+			<li>
+				{_ No items found _}
+			</li>
+		{% endfor %}
+		</ul>
+
+{% endwith %}
+{% endwith %}
diff --git a/modules/mod_mailinglist/templates/_dialog_mailing_cancel_confirm.tpl b/modules/mod_mailinglist/templates/_dialog_mailing_cancel_confirm.tpl
--- a/modules/mod_mailinglist/templates/_dialog_mailing_cancel_confirm.tpl
+++ b/modules/mod_mailinglist/templates/_dialog_mailing_cancel_confirm.tpl
@@ -1,4 +1,4 @@
-<p>{_ Are you sure you want to cancel the mailing to _} “{{ m.rsc[mailinglist_id].title }}”?</p>
-	
-{% button text=_"Cancel mailing" postback={mailing_cancel mailinglist_id=mailinglist_id page_id=page_id} action={dialog_close} %}
-{% button text=_"Keep mailing" action={dialog_close} %}
\ No newline at end of file
+<p>{_ Are you sure you want to cancel the mailing to _} “{{ m.rsc[list_id].title }}”?</p>
+
+{% button text=_"Cancel mailing" postback={mailing_cancel list_id=list_id page_id=page_id} action={dialog_close} %}
+{% button text=_"Keep mailing" action={dialog_close} %}
diff --git a/modules/mod_mailinglist/templates/_dialog_mailing_page.tpl b/modules/mod_mailinglist/templates/_dialog_mailing_page.tpl
--- a/modules/mod_mailinglist/templates/_dialog_mailing_page.tpl
+++ b/modules/mod_mailinglist/templates/_dialog_mailing_page.tpl
@@ -1,18 +1,20 @@
+{% with m.mailinglist.rsc_stats[id] as rsc_stats %}
 
-<p>{_ Select a mailing list to send the page _} {{ m.rsc[id].title }} {_ to: _}</p>
+<p>{_ Please confirm that you want to send the page _} {{ m.rsc[id].title }} {_ to _} {{ m.rsc[list_id].title }}</p>
+
+{% if rsc_stats[list_id].total > 0 %}
+<p><strong>{_ Please note: _}</strong> {_ It appears you have sent
+    this page once already to this list. If you send it again, only
+    the recipients that did not yet receive the mail will get it. As a
+    safety-caution, it is impossible to send the same page twice to
+    the same e-mail address. _}</p>
+
+{% endif %}
+
 
 {% wire type="submit" id=#form postback={mailing_page id=id on_success=on_success} action={dialog_close} delegate=delegate %}
 <form id="{{ #form }}" method="post" action="postback">
-	<select name="mailinglist_id">
-		<option value="" disabled="disabled">{_ Select mailing list _}</option>
-		{% for title, id in m.search[{all_bytitle cat="mailinglist"}] %}
-			{% ifnotequal m.rsc[id].name "mailinglist_test" %}
-				<option value="{{ id }}" {% if not m.rsc[id].is_editable %}disabled="disabled"{% endif %}>{{ title }}</option>
-			{% endifnotequal %}
-		{% endfor %}
-	</select>
-	
-	<div class="clear">&nbsp;</div>
+    <input type="hidden" name="list_id" value="{{ list_id }}" />
 
 	{% if not m.rsc[id].is_published %}
 		<p>{_ The mailing will be send after this page has been published. _}</p>
@@ -25,3 +27,5 @@
 	{% button text=_"Send mailing" %}
 	{% button text=_"Cancel" action={dialog_close} %}
 </form>
+
+{% endwith %}
diff --git a/modules/mod_mailinglist/templates/admin_mailing_status.tpl b/modules/mod_mailinglist/templates/admin_mailing_status.tpl
new file mode 100644
--- /dev/null
+++ b/modules/mod_mailinglist/templates/admin_mailing_status.tpl
@@ -0,0 +1,29 @@
+{% extends "admin_base.tpl" %}
+
+{% block title %}{_ Mailing status _} &mdash; {{ m.rsc[id].title }}{% endblock %}
+
+{% block content %}
+	<div id="content" class="zp-85">
+		<div class="block clearfix">
+
+            <p class="admin-chapeau">{_ mailinglist status page _}:</p>
+            <h2>{{ m.rsc[id].title }}</h2>
+
+            <div class="clearfix">
+                <a href="{% url admin_edit_rsc id=id %}" class="button">{_ edit _}</a>
+                <a href="{% url admin_mailing_preview id=id %}" class="button" onclick="window.open(this.getAttribute('href'), 'mailingpreview', 'width=800,height=800');return false;">{_ preview mailing _}</a>
+                {% button text=_"Send test mailing" class="do_tooltip" title=_"Send this page to the test mailing list." action={mailing_page_test id=id} %}
+            </div>
+
+            <hr />
+
+            <div class="zp-100" id="mailing-status">
+                {% include "_admin_mailing_status_overview.tpl" %}
+            </div>
+
+            {% wire action={connect signal={log_email} action={update target="mailing-status" template="_admin_mailing_status_overview.tpl" id=id}} %}
+            {% wire action={connect signal={update_mailinglist_scheduled} action={update target="mailing-status" template="_admin_mailing_status_overview.tpl" id=id}} %}
+
+		</div>
+	</div>
+{% endblock %}
diff --git a/modules/mod_mailinglist/templates/admin_mailinglist.tpl b/modules/mod_mailinglist/templates/admin_mailinglist.tpl
--- a/modules/mod_mailinglist/templates/admin_mailinglist.tpl
+++ b/modules/mod_mailinglist/templates/admin_mailinglist.tpl
@@ -30,7 +30,7 @@
 					<span class="zp-20">{{ title|default:"untitled" }}</span>
 					<span class="zp-40">{{ m.rsc[id].summary|default:"-" }}</span>
 					{% with m.mailinglist.stats[id] as stats %}
-						<span class="zp-10">{{ (stats[1] + id.s.subscriberof|length)|format_number }}</span>
+						<span class="zp-10">{{ stats[1]|format_number }}</span>
 						<span class="zp-10">{{ stats[2]|length|format_number }}</span>
 					{% endwith %}
 					<span class="zp-20">
diff --git a/src/install/z_install_data.erl b/src/install/z_install_data.erl
--- a/src/install/z_install_data.erl
+++ b/src/install/z_install_data.erl
@@ -57,15 +57,13 @@
     ?DEBUG("Inserting modules"),
     Modules = [
         "mod_base",
-        "mod_emailer",
         "mod_menu",
         "mod_oauth",
         "mod_search",
         "mod_video_embed",
         "mod_atom_feed",
-		"mod_broadcast",
         "mod_translation",
-        "mod_log",
+        "mod_logging",
 
         "mod_seo",
         "mod_seo_google",
@@ -75,13 +73,10 @@
 		"mod_acl_adminonly",
 
         "mod_admin",
-        "mod_admin_address",
         "mod_admin_category",
         "mod_admin_config",
-        "mod_admin_event",
         "mod_admin_identity",
         "mod_admin_modules",
-        "mod_admin_person",
         "mod_admin_predicate",
 
         %% Enable comments
