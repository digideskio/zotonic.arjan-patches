# HG changeset patch
# Parent 38416dfaf9d941c576c0888c95c872025f743c1b
skel site support for 'zotonic addsite'.

 - moved default site to priv/skel/blog
 - simplified addsite script
 - created install mechanism for default data
 - moved demo data from default site to src/install
 - created mechanism to add default menu structure
 - added "-s <skel>" option to addsite
 - updated documentation ZotonicCommands.txt
 - added options to addsite to specify database crdentials
 - added defaults mechanism in $HOME/.zotonic-defaults
 - updated INSTALL instructions
 - added 'empty' skeleton

diff --git a/doc/INSTALL b/doc/INSTALL
--- a/doc/INSTALL
+++ b/doc/INSTALL
@@ -7,8 +7,7 @@
    use packages (see platform-specific notes below)
 
 2. Install ImageMagick (version 6.5 or higher) for the 'convert' and
-   'identify' tools (also install libjpeg, -tiff, -png and other
-   required libraries).  Make sure that the convert and identify tools
+   'identify' tools.  Make sure that the convert and identify tools
    are in your path so that zotonic can find them. For auto-rotation
    to work you'll need the "exif" utility as well.
 
@@ -22,49 +21,51 @@
 Steps to install Zotonic
 ------------------------
 
-Make sure you put the zotonic source in a directory named 'zotonic'
-(important for now; we're working on a solution for this).
-
 1. Type "make" in the root of zotonic (there where the Makefile is located). (*1)
 
-2. Create an user and database in PostgreSQL:
+2. Create an user and database in PostgreSQL (change the password for the user!):
 
-CREATE USER zotonic WITH PASSWORD 'yourdbpassword';
-CREATE DATABASE zotonic WITH OWNER = zotonic ENCODING = 'UTF8';
-GRANT ALL ON DATABASE zotonic TO zotonic;
-\c zotonic
-CREATE LANGUAGE "plpgsql";
+   CREATE USER zotonic WITH PASSWORD 'zotonic';
+   CREATE DATABASE zotonic WITH OWNER = zotonic ENCODING = 'UTF8';
+   GRANT ALL ON DATABASE zotonic TO zotonic;
+   \c zotonic
+   CREATE LANGUAGE "plpgsql";
 
-4. Create the configuration for the default site by copying
-   priv/sites/default/config.in to priv/sites/default/config
+3. Create a new zotonic site, based on the "blog" skeleton site:
 
-5. Edit this file; at least specify the credentials to the postgres database.
+   bin/zotonic addsite -s blog yoursite
 
-5. Make sure that the directory "priv/sites/default" and all its subdirectories are readable 
-   and writeable for the current user. (Which is the user zotonic will run under.)
+   This will add a site named yoursite. Its default URL will be
+   http://yoursite:8000/ so either put 'yoursite' in your hosts
+   file or change the {hostname} section of the config file.
 
-6. Start zotonic in debug mode:
+4. Edit the generated file priv/sites/yoursite/config, to make sure
+   your database credentials and the hostname are correct, and change
+   the password for the admin.
 
-  ./start.sh
+5. Start zotonic in debug mode:
 
-7. You see zotonic starting up, lots of messages pass by, and zotonic will install the initial database.
-   When something goes wrong here, then it is almost always a problem with the database connection. Check your 
-   database configuration in the zotonic.sh file.
+   bin/zotonic debug
+
+7. You see zotonic starting up, lots of messages pass by, and zotonic
+   will install the initial database.  When something goes wrong here,
+   then it is almost always a problem with the database
+   connection. Check your database configuration in the zotonic.sh
+   file.
 
 8. Point your browser to 
 	
-    http://localhost:8000/
+    http://yoursite:8000/
 	
-   or logon as user 'admin' (the default password is empty) at: 
+   or logon as user 'admin' (the default password is 'admin') at:
 
     http://localhost:8000/admin/
 
-   You will be asked to change the admin password before you can proceed into the admin.
-
 9. When all done, then you can stop the erlang shell with:
 
     q().
-  
+
+   or pressing ctrl-c twice.
 
 
 
@@ -114,12 +115,26 @@
 
 Windows
 -------
-Currently, Zotonic has not been tested on the Windows
+Currently, Zotonic is not officially supported on the Windows
 platform. However, the main dependencies Erlang, PostgreSQL and
 ImageMagick do work on Windows, so, if you're adventurous, it should
 be possible to get it running.
 
-For a start, you'll have to compile Zotonic and make a Windows version
-of start.sh, probably as a .bat file.... We'd love to hear your
-progress! Post a message to zotonic-developers@googlegroups.com to
-inform us of your progress.
+We have included user-contributed "start.cmd" and "build.cmd"
+batch-scripts which are supposed to work on Windows.
+
+
+Mac OS X
+--------
+
+With MacPorts you can install Erlang and ImageMagick using the
+following commands:
+
+  sudo port install erlang +ssl
+  sudo port install ImageMagick
+
+EnterpriseDB has an excellent PostgreSQL installer available at
+http://www.enterprisedb.com/products/pgdownload.do#osx
+
+For a very basic step-by-step installation on OSX, chick this
+http://timbenniks.nl/blog/712/step-by-step-guide-to-install-zotonic-on-osx.
diff --git a/doc/ZotonicCommands.txt b/doc/ZotonicCommands.txt
--- a/doc/ZotonicCommands.txt
+++ b/doc/ZotonicCommands.txt
@@ -10,11 +10,27 @@
 this with built-in OS X CLI tools.  This is needed to traverse deeply
 symlinked commands.
 
-zotonic addsite [site_name]
---------------------------
-Create a new site with [site_name] as its name.  This new site will be based
-on the current content of the default site.  It uses the default site as a
-template or skeleton.
+
+zotonic addsite [options] <site_name>
+-------------------------------------
+Create a new site with [site_name] as its name.  This new site will be
+based on a so-called skeleton site. Currently there are two skeletons:
+'blog' and 'empty'. "blog" is the default. 
+
+"zotonic addsite -s empty yoursite" creates a new site called
+"yoursite" based on the skeleton called "empty". Full usage:
+
+zotonic-addsite [options] <site_name>
+
+  -s <skel>    Skeleton site ('blog' or 'empty'; default: blog)
+
+  -h <host>    Database host (default: 127.0.0.1)
+  -p <port>    Database port (default: 5432)
+  -u <user>    Database user (default: zotonic)
+  -P <pass>    Database password (default: zotonic)
+  -d <name>    Database name (default: zotonic)
+  -n <schema>  Database schema (default: public)
+
 
 zotonic copysite [site_name] [source_server]
 --------------------------------------------
@@ -28,6 +44,7 @@
 retrieved from the [source_server].  It does, however, generate and output
 a restore file in case this was run by accident and explains how to recover.
 
+
 zotonic createdb [site_name]
 ----------------------------
 Create a database called zotonic_[site_name] with the basic setup in place to
@@ -38,23 +55,29 @@
 
 	ALTER ROLE zotonic WITH CREATEDB
 
+
 zotonic debug
 -------------
-Launch the Zotonic server interactively and get an EShell on the running
-instance.  This is very similar to running ./start.sh.
+Launch the Zotonic server interactively and get an EShell on the
+running instance.  This command used to be called "./start.sh" in
+Zotonic 0.6 and earlier.
+
 
 zotonic restart
 ---------------
 Restart the background Zotonic server instance.
 
+
 zotonic shell
 -------------
 Connect to the background Zotonic server instance and provide and EShell.
 
+
 zotonic sitedir [site_name]
 ---------------------------
 Get the absolute path for a site based on [site_name]
 
+
 zotonic snapshot [site_name]
 ----------------------------
 Take a version control snapshot of [site_name] including its database content.
@@ -63,15 +86,18 @@
 filename for the SQL backup to make revision-based full site rollbacks
 possible.
 
+
 zotonic start
 -------------
 Start the background Zotonic server instance.
 
+
 zotonic stop
 ------------
 Stop the background Zotonic server instance.
 
+
 zotonic update
 --------------
 Update the server.  Compiles and loads any new code, flushes caches and
-rescans all modules.
\ No newline at end of file
+rescans all modules.
diff --git a/modules/mod_menu/mod_menu.erl b/modules/mod_menu/mod_menu.erl
--- a/modules/mod_menu/mod_menu.erl
+++ b/modules/mod_menu/mod_menu.erl
@@ -33,12 +33,14 @@
     set_menu/3,
     observe_menu_get_rsc_ids/2,
     test/0,
-    menu_flat/1
+    menu_flat/1,
+    convert_symbolic_names/1
 ]).
 
 
 init(Context) ->
-    z_datamodel:manage(?MODULE, datamodel(), Context),
+    z_datamodel:manage(?MODULE, datamodel(Context), Context),
+    z_pivot_rsc:insert_task(?MODULE, convert_symbolic_names, Context),
     case m_config:get(menu, menu_default, Context) of
         undefined -> ok;
         Props -> 
@@ -50,7 +52,7 @@
     end.
 
 
-datamodel() ->
+datamodel(Context) ->
     [
      {categories,
       [
@@ -64,7 +66,7 @@
        {main_menu,
         menu,
         [{title, <<"Main menu">>},
-         {menu, [{312, []}, {313, []}, {314, []}]}
+         {menu, z_install_defaultdata:default_menu(m_site:get(skeleton, Context))}
         ]
        }
       ]}
@@ -153,13 +155,37 @@
         ++ menu_flat(Rest, [Idx+1|PR], [])
         ++  Acc.
 
+
+%% @doc Convert the menu structure as installed (which can contain
+%%      resource names) to a menu which only contains numeric
+%%      ids. This is needed for the menu trail to correctly function.
+convert_symbolic_names(Ctx) ->
+    Context = z_acl:sudo(Ctx),
+    Menu = get_menu(Context),
+    Menu2 = menu_names_to_ids(Menu, Context),
+    set_menu(Menu2, Context),
+    ok.
+
+menu_names_to_ids(Menu, Ctx) ->
+    menu_names_to_ids(Menu, Ctx, []).
+
+menu_names_to_ids([], _Ctx, Acc) ->
+    lists:reverse(Acc);
+menu_names_to_ids([{Item, Childs}|Rest], Context, Acc) ->
+    Id = case Item of
+             X when is_integer(X) -> X;
+             N -> m_rsc:rid(N, Context)
+         end,
+    [{Id, menu_names_to_ids(Childs, Context, [])} | menu_names_to_ids(Rest, Context, Acc)].
+    
+
+%% @doc test function
 %%  111  [1]
 %%  - 44   [1,1]
 %%  - - 555  [1,1,1]
 %%  - - 666  [1,1,2]
 %%  222  [2]
 %%  - 333  [2,1]
-
 test() ->
 
     [
diff --git a/priv/sites/default/default.erl b/priv/skel/blog/SITE.erl
rename from priv/sites/default/default.erl
rename to priv/skel/blog/SITE.erl
--- a/priv/sites/default/default.erl
+++ b/priv/skel/blog/SITE.erl
@@ -1,7 +1,7 @@
-%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
-%% @copyright 2009 Arjan Scherpenisse
-%% @date 2009-12-12
-%% @doc Module implementing a basic blog.
+%% @author %%FULLNAME%%
+%% @copyright %%YEAR%% %%FULLNAME%%
+%% Generated on %%DATE%%
+%% @doc This site was based on the 'blog' skeleton.
 
 %% Licensed under the Apache License, Version 2.0 (the "License");
 %% you may not use this file except in compliance with the License.
@@ -15,133 +15,17 @@
 %% See the License for the specific language governing permissions and
 %% limitations under the License.
 
--module(default).
--author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+-module(%%SITE%%).
+-author("%%FULLNAME%%").
 
--mod_title("Default Zotonic site").
+-mod_title("%%SITE%% zotonic site").
 -mod_description("A simple weblog, used as an example of how to create a Zotonic site.").
 -mod_prio(10).
 
-%% gen_server exports
--export([init/1]).
-
 -include_lib("zotonic.hrl").
 
-%% @doc Initialize the datamodel
-init(Context) ->
-    z_datamodel:manage(?MODULE, datamodel(), Context).
 
 %%====================================================================
-%% support functions
+%% support functions go here
 %%====================================================================
 
-datamodel() ->
-    Now = {{2010,04,03},{9,12,0}},
-    [
-     {resources,
-      [
-
-       %% MENU ENTRIES
-
-       {page_home,
-        text,
-        [{title, <<"Home">>},
-         {summary, <<"Welcome to your blog!">>},
-         {page_path, <<"/">>}]
-       },
-
-       {page_about,
-        text,
-        [{title, <<"About this blog">>},
-         {summary, <<"This is your blog!! It would be wise to type some text here on what you will be writing about. Ofcourse, this page is just a demo page and can be deleted just as well.">>}]
-       },
-
-       {page_contact,
-        text,
-        [{title, <<"Contact">>},
-         {summary, <<"Get in contact with us! Use the form below to send this site's administrator some feedback on how you perceive this site.">>},
-         {page_path, <<"/contact">>}]
-       },
-
-
-       %% BLOG ENTRIES
-
-       {blog_article_welcome,
-        article,
-        [{title, <<"Welcome to Zotonic " ?ZOTONIC_VERSION "!">>},
-         {publication_start, Now},
-         {summary, <<"Zotonic is the content management system for people that want a fast, extensible, flexible and complete system for dynamic web sites. It is built from the ground up with rich internet applications ánd web publishing in mind.">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "welcome.html"])}}
-        ]
-       },
-       {blog_article_learnmore,
-        article,
-        [{title, <<"Want to learn more?">>},
-         {publication_start, z_datetime:prev_day(Now)},
-         {summary, <<"This blog website you're looking demonstrates only a small part of what you can do with a Zotonic site. For instance, did you know that sending mass-mailings is a builtin module? That it does OAuth out of the box? That Zotonic sites are SEO optimized by default?">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "learnmore.html"])}}]
-       },
-       {blog_article_demo,
-        article,
-        [{title, <<"Zotonic's Typography">>},
-         {publication_start, z_datetime:prev_month(Now)},
-         {summary, <<"This article demonstrates the typographic features that Zotonic has. It shows creating ordered and unordered lists, blockquotes, and different methods of embedding media, even even showing an embedded video from Vimeo.com.">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "demo.html"])}}
-        ]
-       },
-
-       %% KEYWORDS
-
-       {kw_announcement,
-        keyword,
-        [{title, <<"Announcement">>}]
-       },
-       {kw_technical,
-        keyword,
-        [{title, <<"Technical">>}]
-       },
-       {kw_support,
-        keyword,
-        [{title, <<"Support">>}]
-       }
-
-      ]
-     },
-
-     {media,
-      [
-       {media_learning,
-        filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "learning.jpg"]),
-        [{title, <<"A bunch of computer books">>},
-         {summary, <<"Taken by Sibi from Flickr, licensed Attribution-Noncommercial-No Derivative Works 2.0.">>}]
-       },
-       {media_welcome,
-        filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "welcome.jpg"]),
-        [{title, <<"Rocky sunrise">>},
-         {summary, <<"Taken by Grant MacDonald from Flickr, CC licensed Attribution-Noncommercial 2.0.">>}]
-       },
-       {media_video,
-        {<<"vimeo">>, <<"<object width=\"400\" height=\"225\"><param name=\"allowfullscreen\" value=\"true\" /><param name=\"allowscriptaccess\" value=\"always\" /><param name=\"movie\" value=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" /><embed src=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" type=\"application/x-shockwave-flash\" allowfullscreen=\"true\" allowscriptaccess=\"always\" width=\"400\" height=\"225\"></embed></object>">>},
-        [{title, <<"Zotonic introduction video">>}]
-       }
-      ]
-     },
-
-     {edges,
-      [
-       {blog_article_learnmore, author, administrator},
-       {blog_article_welcome, author, administrator},
-       {blog_article_demo, author, administrator},
-
-       {blog_article_learnmore, subject, kw_support},
-       {blog_article_demo, subject, kw_technical},
-       {blog_article_welcome, subject, kw_support},
-       {blog_article_welcome, subject, kw_announcement},
-
-       {blog_article_welcome, depiction, media_welcome},
-       {blog_article_learnmore, depiction, media_learning},
-       {blog_article_demo, depiction, media_welcome}
-
-      ]
-     }
-    ].
diff --git a/priv/sites/default/config.in b/priv/skel/blog/config.in
rename from priv/sites/default/config.in
rename to priv/skel/blog/config.in
--- a/priv/sites/default/config.in
+++ b/priv/skel/blog/config.in
@@ -1,33 +1,32 @@
-% Configuration of the default zotonic site.
-% Copy this file to 'config' and change the settings below.
+% Zotonic site configuration for %%SITE%%.
 [
     % This site is enabled or not.
     {enabled, true},
-    
+
     % Atomic hostname, MUST be equal to the directory name of this site.
-    {host, default},
+    {host, %%SITE%%},
 
-    % Hostname for virtual host support. Change this to your real
-    % hostname (e.g. www.example.com) once you move your site to
-    % production.
-    {hostname, "127.0.0.1:8000"},
+    % Hostname on which this site runs
+    {hostname, "%%SITE%%:8000"},
 
     % Aliases which should redirect to the primary hostname
-    {hostalias, "www.example.com"},
-    {hostalias, "example.com"},
+    %{hostalias, "www.example.com"},
+    %{hostalias, "example.com"},
 
-    
     % PostgreSQL database connection
-    {dbhost, "127.0.0.1"},
-    {dbport, 5432},
-    {dbuser, "zotonic"},
-    {dbpassword, "zotonic"},
-    {dbdatabase, "zotonic"},
-    {dbschema, "public"},
-    
+    {dbhost, "%%DBHOST%%"},
+    {dbport, %%DBPORT%%},
+    {dbuser, "%%DBUSER%%"},
+    {dbpassword, "%%DBPASSWORD%%"},
+    {dbdatabase, "%%DBDATABASE%%"},
+    {dbschema, "%%DBSCHEMA%%"},
+
     % Password for the 'admin' user.
     {admin_password, "admin"},
 
+    % What skeleton site this site is based on; for installing the initial data.
+    {skeleton, %%SKEL%%},
+ 
     % Now you'll need to construct two keys. They should be short strings of random characters. Like good passwords, they should be hard to guess.
 
     % Key used for signing image urls with image manipulations (crop, rotate, resize, etc.)
diff --git a/priv/sites/default/dispatch/dispatch b/priv/skel/blog/dispatch/dispatch
rename from priv/sites/default/dispatch/dispatch
rename to priv/skel/blog/dispatch/dispatch
diff --git a/priv/sites/default/files/archive/koe.jpg b/priv/skel/blog/files/archive/koe.jpg
rename from priv/sites/default/files/archive/koe.jpg
rename to priv/skel/blog/files/archive/koe.jpg
diff --git a/priv/sites/default/files/dropbox/.empty b/priv/skel/blog/files/dropbox/.empty
rename from priv/sites/default/files/dropbox/.empty
rename to priv/skel/blog/files/dropbox/.empty
diff --git a/priv/sites/default/files/preview/.empty b/priv/skel/blog/files/preview/.empty
rename from priv/sites/default/files/preview/.empty
rename to priv/skel/blog/files/preview/.empty
diff --git a/priv/sites/default/files/processing/.empty b/priv/skel/blog/files/processing/.empty
rename from priv/sites/default/files/processing/.empty
rename to priv/skel/blog/files/processing/.empty
diff --git a/priv/sites/default/files/unhandled/.empty b/priv/skel/blog/files/unhandled/.empty
rename from priv/sites/default/files/unhandled/.empty
rename to priv/skel/blog/files/unhandled/.empty
diff --git a/priv/sites/default/lib/css/zp-menu.css b/priv/skel/blog/lib/css/zp-menu.css
rename from priv/sites/default/lib/css/zp-menu.css
rename to priv/skel/blog/lib/css/zp-menu.css
diff --git a/priv/sites/default/lib/css/zp-project.css b/priv/skel/blog/lib/css/zp-project.css
rename from priv/sites/default/lib/css/zp-project.css
rename to priv/skel/blog/lib/css/zp-project.css
diff --git a/priv/sites/default/lib/images/arrows-333333.png b/priv/skel/blog/lib/images/arrows-333333.png
rename from priv/sites/default/lib/images/arrows-333333.png
rename to priv/skel/blog/lib/images/arrows-333333.png
diff --git a/priv/sites/default/lib/images/arrows-ffffff.png b/priv/skel/blog/lib/images/arrows-ffffff.png
rename from priv/sites/default/lib/images/arrows-ffffff.png
rename to priv/skel/blog/lib/images/arrows-ffffff.png
diff --git a/priv/sites/default/lib/images/bg.png b/priv/skel/blog/lib/images/bg.png
rename from priv/sites/default/lib/images/bg.png
rename to priv/skel/blog/lib/images/bg.png
diff --git a/priv/sites/default/lib/images/shadow.png b/priv/skel/blog/lib/images/shadow.png
rename from priv/sites/default/lib/images/shadow.png
rename to priv/skel/blog/lib/images/shadow.png
diff --git a/priv/sites/default/modules/.emtpty b/priv/skel/blog/modules/.emtpty
rename from priv/sites/default/modules/.emtpty
rename to priv/skel/blog/modules/.emtpty
diff --git a/priv/sites/default/resources/.emtpty b/priv/skel/blog/resources/.emtpty
rename from priv/sites/default/resources/.emtpty
rename to priv/skel/blog/resources/.emtpty
diff --git a/priv/sites/default/resources/resource_default_contact.erl b/priv/skel/blog/resources/resource_default_contact.erl
rename from priv/sites/default/resources/resource_default_contact.erl
rename to priv/skel/blog/resources/resource_default_contact.erl
diff --git a/priv/sites/default/resources/resource_default_postcomment.erl b/priv/skel/blog/resources/resource_default_postcomment.erl
rename from priv/sites/default/resources/resource_default_postcomment.erl
rename to priv/skel/blog/resources/resource_default_postcomment.erl
diff --git a/priv/sites/default/templates/_article_chapeau.tpl b/priv/skel/blog/templates/_article_chapeau.tpl
rename from priv/sites/default/templates/_article_chapeau.tpl
rename to priv/skel/blog/templates/_article_chapeau.tpl
diff --git a/priv/sites/default/templates/_article_keywords.tpl b/priv/skel/blog/templates/_article_keywords.tpl
rename from priv/sites/default/templates/_article_keywords.tpl
rename to priv/skel/blog/templates/_article_keywords.tpl
diff --git a/priv/sites/default/templates/_article_meta.tpl b/priv/skel/blog/templates/_article_meta.tpl
rename from priv/sites/default/templates/_article_meta.tpl
rename to priv/skel/blog/templates/_article_meta.tpl
diff --git a/priv/sites/default/templates/_article_prevnext.tpl b/priv/skel/blog/templates/_article_prevnext.tpl
rename from priv/sites/default/templates/_article_prevnext.tpl
rename to priv/skel/blog/templates/_article_prevnext.tpl
diff --git a/priv/sites/default/templates/_article_sidebar.tpl b/priv/skel/blog/templates/_article_sidebar.tpl
rename from priv/sites/default/templates/_article_sidebar.tpl
rename to priv/skel/blog/templates/_article_sidebar.tpl
diff --git a/priv/sites/default/templates/_article_summary.tpl b/priv/skel/blog/templates/_article_summary.tpl
rename from priv/sites/default/templates/_article_summary.tpl
rename to priv/skel/blog/templates/_article_summary.tpl
diff --git a/priv/sites/default/templates/_body_media.tpl b/priv/skel/blog/templates/_body_media.tpl
rename from priv/sites/default/templates/_body_media.tpl
rename to priv/skel/blog/templates/_body_media.tpl
diff --git a/priv/sites/default/templates/_email_contact.tpl b/priv/skel/blog/templates/_email_contact.tpl
rename from priv/sites/default/templates/_email_contact.tpl
rename to priv/skel/blog/templates/_email_contact.tpl
diff --git a/priv/sites/default/templates/_listitem.tpl b/priv/skel/blog/templates/_listitem.tpl
rename from priv/sites/default/templates/_listitem.tpl
rename to priv/skel/blog/templates/_listitem.tpl
diff --git a/priv/sites/default/templates/_sidebar.tpl b/priv/skel/blog/templates/_sidebar.tpl
rename from priv/sites/default/templates/_sidebar.tpl
rename to priv/skel/blog/templates/_sidebar.tpl
diff --git a/priv/sites/default/templates/archives.tpl b/priv/skel/blog/templates/archives.tpl
rename from priv/sites/default/templates/archives.tpl
rename to priv/skel/blog/templates/archives.tpl
diff --git a/priv/sites/default/templates/article.tpl b/priv/skel/blog/templates/article.tpl
rename from priv/sites/default/templates/article.tpl
rename to priv/skel/blog/templates/article.tpl
diff --git a/priv/sites/default/templates/base.tpl b/priv/skel/blog/templates/base.tpl
rename from priv/sites/default/templates/base.tpl
rename to priv/skel/blog/templates/base.tpl
diff --git a/priv/sites/default/templates/by_keyword.tpl b/priv/skel/blog/templates/by_keyword.tpl
rename from priv/sites/default/templates/by_keyword.tpl
rename to priv/skel/blog/templates/by_keyword.tpl
diff --git a/priv/sites/default/templates/contact.tpl b/priv/skel/blog/templates/contact.tpl
rename from priv/sites/default/templates/contact.tpl
rename to priv/skel/blog/templates/contact.tpl
diff --git a/priv/sites/default/templates/home.tpl b/priv/skel/blog/templates/home.tpl
rename from priv/sites/default/templates/home.tpl
rename to priv/skel/blog/templates/home.tpl
diff --git a/priv/sites/default/templates/page.query.tpl b/priv/skel/blog/templates/page.query.tpl
rename from priv/sites/default/templates/page.query.tpl
rename to priv/skel/blog/templates/page.query.tpl
diff --git a/priv/sites/default/templates/page.tpl b/priv/skel/blog/templates/page.tpl
rename from priv/sites/default/templates/page.tpl
rename to priv/skel/blog/templates/page.tpl
diff --git a/priv/sites/default/translations/nl.po b/priv/skel/blog/translations/nl.po
rename from priv/sites/default/translations/nl.po
rename to priv/skel/blog/translations/nl.po
diff --git a/priv/sites/default/translations/template/en.pot b/priv/skel/blog/translations/template/en.pot
rename from priv/sites/default/translations/template/en.pot
rename to priv/skel/blog/translations/template/en.pot
diff --git a/priv/sites/default/default.erl b/priv/skel/empty/SITE.erl
copy from priv/sites/default/default.erl
copy to priv/skel/empty/SITE.erl
--- a/priv/sites/default/default.erl
+++ b/priv/skel/empty/SITE.erl
@@ -1,7 +1,7 @@
-%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
-%% @copyright 2009 Arjan Scherpenisse
-%% @date 2009-12-12
-%% @doc Module implementing a basic blog.
+%% @author %%FULLNAME%%
+%% @copyright %%YEAR%% %%FULLNAME%%
+%% Generated on %%DATE%%
+%% @doc This site was based on the 'empty' skeleton.
 
 %% Licensed under the Apache License, Version 2.0 (the "License");
 %% you may not use this file except in compliance with the License.
@@ -15,133 +15,17 @@
 %% See the License for the specific language governing permissions and
 %% limitations under the License.
 
--module(default).
--author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+-module(%%SITE%%).
+-author("%%FULLNAME%%").
 
--mod_title("Default Zotonic site").
--mod_description("A simple weblog, used as an example of how to create a Zotonic site.").
+-mod_title("%%SITE%% zotonic site").
+-mod_description("An empty Zotonic site, to base your site on.").
 -mod_prio(10).
 
-%% gen_server exports
--export([init/1]).
-
 -include_lib("zotonic.hrl").
 
-%% @doc Initialize the datamodel
-init(Context) ->
-    z_datamodel:manage(?MODULE, datamodel(), Context).
 
 %%====================================================================
-%% support functions
+%% support functions go here
 %%====================================================================
 
-datamodel() ->
-    Now = {{2010,04,03},{9,12,0}},
-    [
-     {resources,
-      [
-
-       %% MENU ENTRIES
-
-       {page_home,
-        text,
-        [{title, <<"Home">>},
-         {summary, <<"Welcome to your blog!">>},
-         {page_path, <<"/">>}]
-       },
-
-       {page_about,
-        text,
-        [{title, <<"About this blog">>},
-         {summary, <<"This is your blog!! It would be wise to type some text here on what you will be writing about. Ofcourse, this page is just a demo page and can be deleted just as well.">>}]
-       },
-
-       {page_contact,
-        text,
-        [{title, <<"Contact">>},
-         {summary, <<"Get in contact with us! Use the form below to send this site's administrator some feedback on how you perceive this site.">>},
-         {page_path, <<"/contact">>}]
-       },
-
-
-       %% BLOG ENTRIES
-
-       {blog_article_welcome,
-        article,
-        [{title, <<"Welcome to Zotonic " ?ZOTONIC_VERSION "!">>},
-         {publication_start, Now},
-         {summary, <<"Zotonic is the content management system for people that want a fast, extensible, flexible and complete system for dynamic web sites. It is built from the ground up with rich internet applications ánd web publishing in mind.">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "welcome.html"])}}
-        ]
-       },
-       {blog_article_learnmore,
-        article,
-        [{title, <<"Want to learn more?">>},
-         {publication_start, z_datetime:prev_day(Now)},
-         {summary, <<"This blog website you're looking demonstrates only a small part of what you can do with a Zotonic site. For instance, did you know that sending mass-mailings is a builtin module? That it does OAuth out of the box? That Zotonic sites are SEO optimized by default?">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "learnmore.html"])}}]
-       },
-       {blog_article_demo,
-        article,
-        [{title, <<"Zotonic's Typography">>},
-         {publication_start, z_datetime:prev_month(Now)},
-         {summary, <<"This article demonstrates the typographic features that Zotonic has. It shows creating ordered and unordered lists, blockquotes, and different methods of embedding media, even even showing an embedded video from Vimeo.com.">>},
-         {body, {file, filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "demo.html"])}}
-        ]
-       },
-
-       %% KEYWORDS
-
-       {kw_announcement,
-        keyword,
-        [{title, <<"Announcement">>}]
-       },
-       {kw_technical,
-        keyword,
-        [{title, <<"Technical">>}]
-       },
-       {kw_support,
-        keyword,
-        [{title, <<"Support">>}]
-       }
-
-      ]
-     },
-
-     {media,
-      [
-       {media_learning,
-        filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "learning.jpg"]),
-        [{title, <<"A bunch of computer books">>},
-         {summary, <<"Taken by Sibi from Flickr, licensed Attribution-Noncommercial-No Derivative Works 2.0.">>}]
-       },
-       {media_welcome,
-        filename:join([z_utils:lib_dir(priv), "sites", ?MODULE, "demodata", "welcome.jpg"]),
-        [{title, <<"Rocky sunrise">>},
-         {summary, <<"Taken by Grant MacDonald from Flickr, CC licensed Attribution-Noncommercial 2.0.">>}]
-       },
-       {media_video,
-        {<<"vimeo">>, <<"<object width=\"400\" height=\"225\"><param name=\"allowfullscreen\" value=\"true\" /><param name=\"allowscriptaccess\" value=\"always\" /><param name=\"movie\" value=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" /><embed src=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" type=\"application/x-shockwave-flash\" allowfullscreen=\"true\" allowscriptaccess=\"always\" width=\"400\" height=\"225\"></embed></object>">>},
-        [{title, <<"Zotonic introduction video">>}]
-       }
-      ]
-     },
-
-     {edges,
-      [
-       {blog_article_learnmore, author, administrator},
-       {blog_article_welcome, author, administrator},
-       {blog_article_demo, author, administrator},
-
-       {blog_article_learnmore, subject, kw_support},
-       {blog_article_demo, subject, kw_technical},
-       {blog_article_welcome, subject, kw_support},
-       {blog_article_welcome, subject, kw_announcement},
-
-       {blog_article_welcome, depiction, media_welcome},
-       {blog_article_learnmore, depiction, media_learning},
-       {blog_article_demo, depiction, media_welcome}
-
-      ]
-     }
-    ].
diff --git a/priv/sites/default/config.in b/priv/skel/empty/config.in
copy from priv/sites/default/config.in
copy to priv/skel/empty/config.in
--- a/priv/sites/default/config.in
+++ b/priv/skel/empty/config.in
@@ -1,52 +1,41 @@
-% Configuration of the default zotonic site.
-% Copy this file to 'config' and change the settings below.
+% Zotonic site configuration for %%SITE%%.
 [
     % This site is enabled or not.
     {enabled, true},
-    
+
     % Atomic hostname, MUST be equal to the directory name of this site.
-    {host, default},
+    {host, %%SITE%%},
 
-    % Hostname for virtual host support. Change this to your real
-    % hostname (e.g. www.example.com) once you move your site to
-    % production.
-    {hostname, "127.0.0.1:8000"},
+    % Hostname on which this site runs
+    {hostname, "%%SITE%%:8000"},
 
     % Aliases which should redirect to the primary hostname
-    {hostalias, "www.example.com"},
-    {hostalias, "example.com"},
+    %{hostalias, "www.example.com"},
+    %{hostalias, "example.com"},
 
-    
     % PostgreSQL database connection
-    {dbhost, "127.0.0.1"},
-    {dbport, 5432},
-    {dbuser, "zotonic"},
-    {dbpassword, "zotonic"},
-    {dbdatabase, "zotonic"},
-    {dbschema, "public"},
-    
+    {dbhost, "%%DBHOST%%"},
+    {dbport, %%DBPORT%%},
+    {dbuser, "%%DBUSER%%"},
+    {dbpassword, "%%DBPASSWORD%%"},
+    {dbdatabase, "%%DBDATABASE%%"},
+    {dbschema, "%%DBSCHEMA%%"},
+
     % Password for the 'admin' user.
     {admin_password, "admin"},
 
+    % What skeleton site this site is based on; for installing the initial data.
+    {skeleton, %%SKEL%%},
+
     % Now you'll need to construct two keys. They should be short strings of random characters. Like good passwords, they should be hard to guess.
 
     % Key used for signing image urls with image manipulations (crop, rotate, resize, etc.)
     %  This key will help prevent denial of service attacks.
     % A new key will also forces regenerating images, which takes cpu time and will fill your hard disk.
     {sign_key_simple, <<"--change-me--">>},
-    
+
     % Key used for signing postbacks - this _must_ be a hard to guess key, otherwise your system is insecure.
     % When not defined, then zotonic will generate a new key on every restart.
     % When a new key is generated then all postbacks from old html pages will fail.
-    {sign_key, <<"--change-me--">>},
-
-    %% Specific options
-
-    %% Title of your site
-    {title, <<"Your first blog">>},
-    %% Subtitle
-    {subtitle, <<"built with Zotonic, the Erlang CMS.">>},
-
-    %% Page length
-    {pagelen, 5}
+    {sign_key, <<"--change-me--">>}
 ].
diff --git a/priv/sites/default/dispatch/dispatch b/priv/skel/empty/dispatch/dispatch
copy from priv/sites/default/dispatch/dispatch
copy to priv/skel/empty/dispatch/dispatch
--- a/priv/sites/default/dispatch/dispatch
+++ b/priv/skel/empty/dispatch/dispatch
@@ -1,12 +1,6 @@
-%% Dispatch rules for mod_zotonic.
+%% Put your dispatch rules here.
 
 [
-    {home,      [],                         resource_page,  	[ {template, "home.tpl"}, {id, page_home} ]},
-    {article,   ["article", id, slug],      resource_page,  	[ {template, "article.tpl"}, {cat, article} ]},
-    {keyword,	["by_keyword", id, slug],	resource_page,		[ {template, "by_keyword.tpl"} ]},
+%    {home,      [],	resource_template,  	[ {template, "home.tpl"} ]}
+].
 
-    {page_contact,	["contact"],            resource_page,		[ {template, "contact.tpl"}, {id, page_contact} ]},
-
-    {archives_y,["archives", year],			resource_template,	[ {template, "archives.tpl"}, {cat, article} ]},
-    {archives_m,["archives", year, month],	resource_template,	[ {template, "archives.tpl"}, {cat, article} ]}
-].
diff --git a/priv/skel/empty/files/archive/.empty b/priv/skel/empty/files/archive/.empty
new file mode 100644
--- /dev/null
+++ b/priv/skel/empty/files/archive/.empty
@@ -0,0 +1,1 @@
+
diff --git a/priv/sites/default/files/dropbox/.empty b/priv/skel/empty/files/dropbox/.empty
copy from priv/sites/default/files/dropbox/.empty
copy to priv/skel/empty/files/dropbox/.empty
diff --git a/priv/sites/default/files/preview/.empty b/priv/skel/empty/files/preview/.empty
copy from priv/sites/default/files/preview/.empty
copy to priv/skel/empty/files/preview/.empty
diff --git a/priv/sites/default/files/processing/.empty b/priv/skel/empty/files/processing/.empty
copy from priv/sites/default/files/processing/.empty
copy to priv/skel/empty/files/processing/.empty
diff --git a/priv/sites/default/files/unhandled/.empty b/priv/skel/empty/files/unhandled/.empty
copy from priv/sites/default/files/unhandled/.empty
copy to priv/skel/empty/files/unhandled/.empty
diff --git a/priv/skel/empty/lib/css/.empty b/priv/skel/empty/lib/css/.empty
new file mode 100644
diff --git a/priv/skel/empty/lib/images/.empty b/priv/skel/empty/lib/images/.empty
new file mode 100644
diff --git a/priv/sites/default/demodata/demo.html b/src/install/defaultdata/blog/demo.html
rename from priv/sites/default/demodata/demo.html
rename to src/install/defaultdata/blog/demo.html
diff --git a/priv/sites/default/demodata/learning.jpg b/src/install/defaultdata/blog/learning.jpg
rename from priv/sites/default/demodata/learning.jpg
rename to src/install/defaultdata/blog/learning.jpg
diff --git a/priv/sites/default/demodata/learnmore.html b/src/install/defaultdata/blog/learnmore.html
rename from priv/sites/default/demodata/learnmore.html
rename to src/install/defaultdata/blog/learnmore.html
diff --git a/priv/sites/default/demodata/welcome.html b/src/install/defaultdata/blog/welcome.html
rename from priv/sites/default/demodata/welcome.html
rename to src/install/defaultdata/blog/welcome.html
diff --git a/priv/sites/default/demodata/welcome.jpg b/src/install/defaultdata/blog/welcome.jpg
rename from priv/sites/default/demodata/welcome.jpg
rename to src/install/defaultdata/blog/welcome.jpg
diff --git a/src/install/z_install.erl b/src/install/z_install.erl
--- a/src/install/z_install.erl
+++ b/src/install/z_install.erl
@@ -64,7 +64,19 @@
                                    end
                                ),
     pgsql_pool:return_connection(Host, C),
-    m_category:renumber(z_context:new(Host, en)),
+    
+    InstallData = fun() ->
+                          timer:sleep(200), %% give other processes some time to start
+                          
+                          Context = z_context:new(Host, en),
+                          
+                          %% install the default data for the skeleton the site is based on
+                          z_install_defaultdata:install(m_site:get(skeleton, Context), Context),
+                          
+                          %% renumber the category tree.
+                          m_category:renumber(Context)
+                  end,
+    spawn(InstallData),
     ok.
 
 
diff --git a/src/install/z_install_data.erl b/src/install/z_install_data.erl
--- a/src/install/z_install_data.erl
+++ b/src/install/z_install_data.erl
@@ -42,7 +42,6 @@
     ?DEBUG({Host, "Install done."}),
     ok.
 
-
 %% @doc Install all configuration parameters with default values
 %% @spec install_config(Connection) -> ok
 install_config(C) ->
@@ -268,3 +267,4 @@
         || {CatId, Nr, Level, Left, Right, Path} <- Enums
     ],
     ok.
+
diff --git a/src/install/z_install_defaultdata.erl b/src/install/z_install_defaultdata.erl
new file mode 100644
--- /dev/null
+++ b/src/install/z_install_defaultdata.erl
@@ -0,0 +1,157 @@
+%% @author Arjan Scherpenisse <arjan@scherpenisse.net>
+%% @copyright 2011 Arjan Scherpenisse
+%%
+%% @doc Installs default data in a Zotonic site.
+
+%% Copyright 2011 Arjan Scherpenisse
+%%
+%% Licensed under the Apache License, Version 2.0 (the "License");
+%% you may not use this file except in compliance with the License.
+%% You may obtain a copy of the License at
+%% 
+%%     http://www.apache.org/licenses/LICENSE-2.0
+%% 
+%% Unless required by applicable law or agreed to in writing, software
+%% distributed under the License is distributed on an "AS IS" BASIS,
+%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+%% See the License for the specific language governing permissions and
+%% limitations under the License.
+
+-module(z_install_defaultdata).
+-author("Arjan Scherpenisse <arjan@scherpenisse.net>").
+
+-include("zotonic.hrl").
+
+%% interface functions
+-export([
+    install/2,
+    default_menu/1
+]).
+
+
+install(blog, Context) ->
+    Now = {{2010,04,03},{9,12,0}},
+    Datamodel = 
+        #datamodel{
+      resources =
+      [
+       
+       %% MENU ENTRIES
+       
+       {page_home,
+        text,
+        [{title, <<"Home">>},
+         {summary, <<"Welcome to your blog!">>},
+         {page_path, <<"/">>}]
+       },
+
+       {page_about,
+        text,
+        [{title, <<"About this blog">>},
+         {summary, <<"This is your blog!! It would be wise to type some text here on what you will be writing about. Ofcourse, this page is just a demo page and can be deleted just as well.">>}]
+       },
+
+       {page_contact,
+        text,
+        [{title, <<"Contact">>},
+         {summary, <<"Get in contact with us! Use the form below to send this site's administrator some feedback on how you perceive this site.">>},
+         {page_path, <<"/contact">>}]
+       },
+
+       %% BLOG ENTRIES
+
+       {blog_article_welcome,
+        article,
+        [{title, <<"Welcome to Zotonic " ?ZOTONIC_VERSION "!">>},
+         {publication_start, Now},
+         {summary, <<"Zotonic is the content management system for people that want a fast, extensible, flexible and complete system for dynamic web sites. It is built from the ground up with rich internet applications ánd web publishing in mind.">>},
+         {body, {file, datafile(blog, "welcome.html")}}
+        ]
+       },
+       {blog_article_learnmore,
+        article,
+        [{title, <<"Want to learn more?">>},
+         {publication_start, z_datetime:prev_day(Now)},
+         {summary, <<"This blog website you're looking demonstrates only a small part of what you can do with a Zotonic site. For instance, did you know that sending mass-mailings is a builtin module? That it does OAuth out of the box? That Zotonic sites are SEO optimized by default?">>},
+         {body, {file, datafile(blog, "learnmore.html")}}
+        ]
+       },
+       {blog_article_demo,
+        article,
+        [{title, <<"Zotonic's Typography">>},
+         {publication_start, z_datetime:prev_month(Now)},
+         {summary, <<"This article demonstrates the typographic features that Zotonic has. It shows creating ordered and unordered lists, blockquotes, and different methods of embedding media, even even showing an embedded video from Vimeo.com.">>},
+         {body, {file, datafile(blog, "demo.html")}}
+        ]
+       },
+
+       %% KEYWORDS
+
+       {kw_announcement,
+        keyword,
+        [{title, <<"Announcement">>}]
+       },
+       {kw_technical,
+        keyword,
+        [{title, <<"Technical">>}]
+       },
+       {kw_support,
+        keyword,
+        [{title, <<"Support">>}]
+       }
+      ],
+
+      media =
+      [
+       {media_learning,
+        datafile(blog, "learning.jpg"),
+        [{title, <<"A bunch of computer books">>},
+         {summary, <<"Taken by Sibi from Flickr, licensed Attribution-Noncommercial-No Derivative Works 2.0.">>}]
+       },
+       {media_welcome,
+        datafile(blog, "welcome.jpg"),
+        [{title, <<"Rocky sunrise">>},
+         {summary, <<"Taken by Grant MacDonald from Flickr, CC licensed Attribution-Noncommercial 2.0.">>}]
+       },
+       {media_video,
+        {<<"vimeo">>, <<"<object width=\"400\" height=\"225\"><param name=\"allowfullscreen\" value=\"true\" /><param name=\"allowscriptaccess\" value=\"always\" /><param name=\"movie\" value=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" /><embed src=\"http://vimeo.com/moogaloop.swf?clip_id=7630916&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=0&amp;show_portrait=0&amp;color=&amp;fullscreen=1\" type=\"application/x-shockwave-flash\" allowfullscreen=\"true\" allowscriptaccess=\"always\" width=\"400\" height=\"225\"></embed></object>">>},
+          [{title, <<"Zotonic introduction video">>}]
+       }
+      ],
+
+      edges = 
+      [
+       {blog_article_learnmore, author, administrator},
+       {blog_article_welcome, author, administrator},
+       {blog_article_demo, author, administrator},
+       
+       {blog_article_learnmore, subject, kw_support},
+       {blog_article_demo, subject, kw_technical},
+       {blog_article_welcome, subject, kw_support},
+       {blog_article_welcome, subject, kw_announcement},
+       
+       {blog_article_welcome, depiction, media_welcome},
+       {blog_article_learnmore, depiction, media_learning},
+       {blog_article_demo, depiction, media_welcome}
+       
+      ]
+     },
+
+    ?DEBUG("Install blog"),
+    z_datamodel:manage(?MODULE, Datamodel, Context);
+
+
+install(_, _) ->
+    %% no/unknown skeleton = no default data
+    ok.
+
+%% @doc Retrieve the default menu structure for a given skeleton site. Used by mod_menu to create the menu.
+default_menu(blog) ->
+    [{page_home, []}, {page_about, []}, {page_contact, []}];
+
+default_menu(undefined) ->
+    [].
+
+
+datafile(Skeleton, Filename) ->
+    filename:join([z_utils:lib_dir(src), "install", "defaultdata", Skeleton, Filename]).
diff --git a/src/scripts/helpers/zotonic-addsite_config.sed.in b/src/scripts/helpers/zotonic-addsite_config.sed.in
deleted file mode 100644
--- a/src/scripts/helpers/zotonic-addsite_config.sed.in
+++ /dev/null
@@ -1,3 +0,0 @@
-s/{host, default},/{host, yoursite},/
-s/{dbdatabase, "zotonic"},/{dbdatabase, "zotonic_yoursite"},/
-s/{hostname, "127.0.0.1:8000"},/{hostname, "yoursite:8000"},/
\ No newline at end of file
diff --git a/src/scripts/helpers/zotonic-addsite_module.sed.in b/src/scripts/helpers/zotonic-addsite_module.sed.in
deleted file mode 100644
--- a/src/scripts/helpers/zotonic-addsite_module.sed.in
+++ /dev/null
@@ -1,2 +0,0 @@
-s/-module(default)/-module(yoursite)/
-s/-mod_title([^)]*)/-mod_title("yoursite Name Here")/
\ No newline at end of file
diff --git a/src/scripts/zotonic-addsite b/src/scripts/zotonic-addsite
--- a/src/scripts/zotonic-addsite
+++ b/src/scripts/zotonic-addsite
@@ -5,9 +5,9 @@
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
-# 
+#
 #	 http://www.apache.org/licenses/LICENSE-2.0
-# 
+#
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@@ -18,46 +18,110 @@
 # usage zotonic-addsite [site_name]
 #
 
-SITE=$1
+function usage {
+    echo "Usage: `basename $0` [options] <site_name>" 1>&2
+    echo 1>&2
+    echo "  -s <skel>    Skeleton site ('blog' or 'empty'; default: $SKEL)" 1>&2
+    echo 1>&2
+    echo "  -h <host>    Database host (default: $DBHOST)" 1>&2
+    echo "  -p <port>    Database port (default: $DBPORT)" 1>&2
+    echo "  -u <user>    Database user (default: $DBUSER)" 1>&2
+    echo "  -P <pass>    Database password (default: $DBPASSWORD)" 1>&2
+    echo "  -d <name>    Database name (default: $DBDATABASE)" 1>&2
+    echo "  -n <schema>  Database schema (default: $DBSCHEMA)" 1>&2
+    echo 1>&2
+    #echo 1>&2
+    exit 1
+}
 
-if [ ! $SITE ]
-  then
-	echo USAGE: $0 [site_name] 1>&2
-	echo USAGE: See ZotonicCommands.txt 1>&2
-  else
-	if [ -e $SITES/$SITE ]
-	  then
-		echo $0: cannot add site "\`$SITE'": $SITES/$SITE already exists 1>&2
-	  else
-		# Copy the default site as a template
-		cp -R $SITES/default $SITES/$SITE
+#
+# Perform the actual adding of the site
+#
+function do_addsite {
+     # Copy the default site as a template
+    cp -pR $SKELDIR $SITES/$SITE
 
-		# Remove duplicate module
-		rm $SITES/$SITE/default.erl
+    cd $SITES/$SITE
 
-		# Generate Site Module refactor script
-		REFACTOR_MODULE=`tempfile`
-		sed s/yoursite/$SITE/g \
-			< $ZOTONIC_SCRIPTS/helpers/zotonic-addsite_module.sed.in \
-			> $REFACTOR_MODULE
+    # Remove placeholder .empty files
+    rm `find . -name .empty`
 
-		# Refactor Site Module
-		sed -f "$REFACTOR_MODULE" \
-			< $SITES/default/default.erl \
-			> $SITES/$SITE/$SITE.erl
+    # move site module in place
+    mv SITE.erl $SITE.erl
 
-		# Generate Site Config refactor script
-		REFACTOR_CONFIG=`tempfile`
-		sed s/yoursite/$SITE/g \
-			< $ZOTONIC_SCRIPTS/helpers/zotonic-addsite_config.sed.in \
-			> $REFACTOR_CONFIG
+    # move config in place
+    mv config.in config
 
-		# Refactor Site Config
-		sed -f $REFACTOR_CONFIG \
-			< $SITES/default/config.in \
-			> $SITES/$SITE/config
+    # Some handy variables
+    FULLNAME=`getent passwd "$USER" | cut -d ':' -f 5|cut -d ',' -f 1`
+    YEAR=`date +'%Y'`
+    DATE=`date +'%Y-%m-%d'`
 
-		# Make the new site
-		make --silent --directory=$ZOTONIC
-	fi
-fi
+    # simple key-value replace
+    seds=""
+    for var in SITE SKEL FULLNAME DBHOST DBPORT DBUSER DBPASSWORD DBDATABASE DBSCHEMA; do
+        seds="s/%%$var%%/${!var}/g;$seds"
+    done
+    sed -i -e "$seds" $SITE.erl config
+
+    # Make the new site
+    make -C $ZOTONIC
+    zotonic restart
+
+    echo
+    echo "Added site $SITE. go to http://$SITE:${ZOTONIC_PORT:=8000}/ to view it."
+}
+
+
+#
+# Get the options for the addsite command.
+#
+function check_options {
+
+    if [ -f "$HOME/.zotonic-defaults" ]; then
+        source "$HOME/.zotonic-defaults"
+    fi
+
+    # The defaults
+    SKEL=${SKEL:=blog}
+    DBHOST=${DBHOST:=127.0.0.1}
+    DBPORT=${DBPORT:=5432}
+    DBUSER=${DBUSER:=zotonic}
+    DBPASSWORD=${DBPASSWORD:=zotonic}
+    DBDATABASE=${DBDATABASE:=zotonic}
+    DBSCHEMA=${DBSCHEMA:=public}
+
+    while getopts "s:d:h:p:u:P:n:" optionName; do
+        case "$optionName" in
+            s) SKEL="$OPTARG"; shift; shift ;;
+            h) DBHOST="$OPTARG"; shift; shift ;;
+            p) DBPORT="$OPTARG"; shift; shift ;;
+            u) DBUSER="$OPTARG"; shift; shift ;;
+            P) DBPASSWORD="$OPTARG"; shift; shift ;;
+            d) DBDATABASE="$OPTARG"; shift; shift ;;
+            n) DBSCHEMA="$OPTARG"; shift; shift ;;
+            [?]) exit
+        esac
+    done
+
+    SITE=$1
+    if [ ! $SITE ]; then
+        usage
+    fi
+
+    if [ -e $SITES/$SITE ]; then
+	    echo `basename $0`: cannot add site "\`$SITE'": $SITES/$SITE already exists 1>&2
+        exit 1
+    fi
+
+    SKELDIR="$ZOTONIC/priv/skel/$SKEL"
+    if [ ! -e $SKELDIR ]; then
+	    echo `basename $0`: skeleton site $SKEL does not exists 1>&2
+        exit 1
+    fi
+}
+
+
+check_options $*
+do_addsite
+
